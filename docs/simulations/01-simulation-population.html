<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.18">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Simulation: Population Estimate – Day 2: SPARCC Causal Inference Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-c4d1a0b15fb91c8b9d729b67b2b4f5b3.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-c4d1a0b15fb91c8b9d729b67b2b4f5b3.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-c4d1a0b15fb91c8b9d729b67b2b4f5b3.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d03cad9afce31885090b44f607f3c00f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-9d0eea9eb531491e856ca013ebdc81d3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-d03cad9afce31885090b44f607f3c00f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Day 2: SPARCC Causal Inference Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">🏠 Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content-sparcc-day-2-(bulbulia" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">📚 CONTENT: SPARCC Day 2 (Bulbulia)</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-content-sparcc-day-2-(bulbulia">    
        <li>
    <a class="dropdown-item" href="../content/00-background.html">
 <span class="dropdown-text">1. What is Causality?</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-background.html">
 <span class="dropdown-text">2. Identification Using Causal DAGs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-causal-workflow.html">
 <span class="dropdown-text">3. Causal Workflow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-interaction.html">
 <span class="dropdown-text">4. Average and Conditional Average Treatment Effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-measurement.html">
 <span class="dropdown-text">5. Measurement Matters</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../workshop-scripts/06-interpretation-2.html">
 <span class="dropdown-text">6. Code Review</span></a>
  </li>  
        <li class="dropdown-header">Simulations</li>
        <li>
    <a class="dropdown-item" href="../simulations/01-simulation-population.html">
 <span class="dropdown-text">Simulation: Population Estimate</span></a>
  </li>  
        <li class="dropdown-header">ggdag</li>
        <li>
    <a class="dropdown-item" href="../content/ggdag-examples.html">
 <span class="dropdown-text">Causal Diagrams: The Structures of Interaction/Effect Modification, Measurement Bias, Selection Bias</span></a>
  </li>  
        <li class="dropdown-header">References</li>
        <li>
    <a class="dropdown-item" href="../pdfs/bulbulia-hand-outs/S2-glossary.pdf">
 <span class="dropdown-text">Glossary (PDF)</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../quiz/sparcc_day_2_short_quiz.pdf">
 <span class="dropdown-text">Short Quiz</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../quiz/sparcc_day_2_short_quiz-answer-key.pdf">
 <span class="dropdown-text">Short Quiz Answer Key</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../quiz/2025-SPARCC-DAY-2-TEST.pdf">
 <span class="dropdown-text">Test</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../glossary-and-dags.html"> 
<span class="menu-text">📊 Glossary &amp; DAGs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reading.html"> 
<span class="menu-text">📚 Reading</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://go-bayes.github.io/sparcc-day-1/"> 
<span class="menu-text">Link to Day 1 Workshop (by B.G. Purzycki)</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/go-bayes"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">Research Code</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#simulations" id="toc-simulations" class="nav-link active" data-scroll-target="#simulations">Simulations</a></li>
  <li><a href="#id-app-b" id="toc-id-app-b" class="nav-link" data-scroll-target="#id-app-b">S2. Generalisability and Transportability</a></li>
  <li><a href="#id-app-c" id="toc-id-app-c" class="nav-link" data-scroll-target="#id-app-c">S3. A Mathematical Explanation for the Difference in Marginal Effects between Censored and Uncensored Populations</a></li>
  <li><a href="#lessons" id="toc-lessons" class="nav-link" data-scroll-target="#lessons">Lessons</a></li>
  <li><a href="#ambiguities-from-cross-sectional-data" id="toc-ambiguities-from-cross-sectional-data" class="nav-link" data-scroll-target="#ambiguities-from-cross-sectional-data">Ambiguities from Cross-Sectional Data</a>
  <ul class="collapse">
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a></li>
  <li><a href="#steps-to-estimate-the-ate" id="toc-steps-to-estimate-the-ate" class="nav-link" data-scroll-target="#steps-to-estimate-the-ate">Steps to Estimate the ATE</a></li>
  <li><a href="#upshot-of-the-simulation-and-analysis" id="toc-upshot-of-the-simulation-and-analysis" class="nav-link" data-scroll-target="#upshot-of-the-simulation-and-analysis">Upshot of the Simulation and Analysis</a></li>
  </ul></li>
  <li><a href="#appendix-d" id="toc-appendix-d" class="nav-link" data-scroll-target="#appendix-d">Appendix D: Simulation of Different Confounding Control Strategies</a>
  <ul class="collapse">
  <li><a href="#methodology-1" id="toc-methodology-1" class="nav-link" data-scroll-target="#methodology-1">Methodology</a></li>
  </ul></li>
  <li><a href="#appendix-causal-forests" id="toc-appendix-causal-forests" class="nav-link" data-scroll-target="#appendix-causal-forests">Appendix E: Non-parametric Estimation of Average Treatment Effects Using Causal Forests</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Simulation: Population Estimate</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="simulations" class="level2">
<h2 class="anchored" data-anchor-id="simulations">Simulations</h2>
<ul>
<li>S2 and S3 are from the supplement to <span class="citation" data-cites="bulbulia2024wierd">Bulbulia (<a href="#ref-bulbulia2024wierd" role="doc-biblioref">2024b</a>)</span>. S2 is a simulation. It illustrates how, if the distribution of effect-modifiers in one’s sample differs from that of the target population, the marginal effect estimate (ATE) will be biased. S3 offers a mathmatical explanation for this result. These simulations are followed by others that clarify how inference may fail when the true timing of events in one’s measures differs from what is assumed.</li>
</ul>
</section>
<section id="id-app-b" class="level2">
<h2 class="anchored" data-anchor-id="id-app-b">S2. Generalisability and Transportability</h2>
<p>Generalisability: When a study sample is drawn randomly from the target population, we may generalise from the sample to the target population as follows.</p>
<p>Suppose we sample randomly from the target population, where:</p>
<ul>
<li><span class="math inline">n_S</span> denotes the size of the study’s analytic sample <span class="math inline">S</span>.</li>
<li><span class="math inline">N_T</span> denotes the total size of the target population <span class="math inline">T</span>.</li>
<li><span class="math inline">\widehat{ATE}_{n_S}</span> denotes the estimated average treatment effect in the analytic sample <span class="math inline">S</span>.</li>
<li><span class="math inline">ATE_{T}</span> denotes the true average treatment effect in the target population <span class="math inline">T</span>.</li>
<li><span class="math inline">\epsilon</span> denotes an arbitrarily small positive value.</li>
</ul>
<p>Assuming the rest of the causal inference workflow goes to plan (randomisation succeeds, there is no measurement error, no model misspecification, etc.), as the random sample size <span class="math inline">n_S</span> increases, the estimated treatment effect in the analytic sample <span class="math inline">S</span> converges in probability to the true treatment effect in the target population <span class="math inline">T</span>:</p>
<p><span class="math display">
\lim_{n_S \to \infty} P(|\widehat{ATE}_{n_S} - ATE_{T}| &lt; \epsilon) = 1
</span></p>
<p>for any small positive value of <span class="math inline">\epsilon</span>.</p>
<p>Transportability: When the analytic sample is not drawn from the target population, we cannot directly generalise the findings. However, we can transport the estimated causal effect from the source population to the target population under certain assumptions. This involves adjusting for differences in the distributions of effect modifiers between the two populations. The closer the source population is to the target population, the more plausible the transportability assumptions are, and the less we need to rely on complex adjustment methods. Suppose we have an analytic sample <span class="math inline">n_S</span> drawn from a source population <span class="math inline">S</span>, and we want to estimate the average treatment effect in a target population <span class="math inline">T</span>. Define:</p>
<p><span class="math inline">\widehat{ATE}_{S}</span> as the estimated average treatment effect in the analytic sample drawn from the source population <span class="math inline">S</span>. <span class="math inline">\widehat{ATE}_{T}</span> as the estimated average treatment effect in the target population <span class="math inline">T</span>. <span class="math inline">f(n_S, R)</span> as the mapping function that adjusts the estimated effect in the analytic sample using a set of measured covariates <span class="math inline">R</span>, allowing for valid projection from the source population to the target population.</p>
<p>The transportability assumption is that there exists a function <span class="math inline">f</span> such that: <span class="math display">
\widehat{ATE}_{T} = f(\widehat{ATE}_S, R)
</span></p>
<p>Here, <span class="math inline">\widehat{ATE}_S</span> is the estimated average treatment effect from the source population, and <span class="math inline">R</span> represents the set of covariates used for adjustment.</p>
<p>Finding a suitable function <span class="math inline">f</span> is the central challenge in adjusting for sampling bias and achieving transportability <span class="citation" data-cites="bareinboim2013general westreich2017transportability dahabreh2019generalizing deffner2022">(<a href="#ref-bareinboim2013general" role="doc-biblioref">Bareinboim and Pearl 2013</a>; <a href="#ref-westreich2017transportability" role="doc-biblioref">Westreich et al. 2017</a>; <a href="#ref-dahabreh2019generalizing" role="doc-biblioref">Issa J. Dahabreh et al. 2019</a>; <a href="#ref-deffner2022" role="doc-biblioref">Deffner, Rohrer, and McElreath 2022</a>)</span>.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="id-app-c" class="level2">
<h2 class="anchored" data-anchor-id="id-app-c">S3. A Mathematical Explanation for the Difference in Marginal Effects between Censored and Uncensored Populations</h2>
<p>This appendix provides an explanation for why marginal effects may differ between the censored and uncensored sample population in the absence of unmeasured confounding.</p>
<section id="definitions" class="level4">
<h4 class="anchored" data-anchor-id="definitions">Definitions:</h4>
<ul>
<li><strong><span class="math inline">A</span></strong>: Exposure variable, where <span class="math inline">a</span> represents the reference level and <span class="math inline">a^*</span> represents the comparison level</li>
<li><strong><span class="math inline">Y</span></strong>: Outcome variable</li>
<li><strong><span class="math inline">F</span></strong>: Effect modifier</li>
<li><strong><span class="math inline">C</span></strong>: Indicator for the uncensored population (<span class="math inline">C = 0</span>) or the censored population (<span class="math inline">C = 1</span>)</li>
</ul>
</section>
<section id="average-treatment-effects" class="level4">
<h4 class="anchored" data-anchor-id="average-treatment-effects">Average Treatment Effects:</h4>
<p>The average treatment effects for the uncensored and censored populations are defined as:</p>
<p><span class="math display"> \Delta_{\text{uncensored}} = \mathbb{E}[Y(a^*) - Y(a) \mid C = 0] </span></p>
<p><span class="math display"> \Delta_{\text{censored}} = \mathbb{E}[Y(a^*) - Y(a) \mid C = 1] </span></p>
</section>
<section id="potential-outcomes" class="level4">
<h4 class="anchored" data-anchor-id="potential-outcomes">Potential Outcomes:</h4>
<p>By causal consistency, potential outcomes can be expressed in terms of observed outcomes:</p>
<p><span class="math display"> \Delta_{\text{uncensored}} = \mathbb{E}[Y \mid A=a^*, C=0] - \mathbb{E}[Y \mid A=a, C=0] </span></p>
<p><span class="math display"> \Delta_{\text{censored}} = \mathbb{E}[Y \mid A=a^*, C=1] - \mathbb{E}[Y \mid A=a, C=1] </span></p>
</section>
<section id="law-of-total-probability" class="level4">
<h4 class="anchored" data-anchor-id="law-of-total-probability">Law of Total Probability:</h4>
<p>Applying the Law of Total Probability, we can weight the average treatment effects by the conditional probability of the effect modifier <span class="math inline">F</span>:</p>
<p><span class="math display"> \Delta_{\text{uncensored}} = \sum_{f} \Big\{\mathbb{E}[Y \mid A=a^*, F=f, C=0] - \mathbb{E}[Y \mid A=a, F=f, C=0]\Big\} \times \Pr(F=f \mid C=0) </span></p>
<p><span class="math display">
\Delta_{\text{censored}} = \sum_{f} \Big\{\mathbb{E}[Y \mid A=a^*, F=f, C=1] - \mathbb{E}[Y \mid A=a, F=f, C=1]\Big\} \times \Pr(F=f \mid C=1)
</span></p>
</section>
<section id="assumption-of-informative-censoring" class="level4">
<h4 class="anchored" data-anchor-id="assumption-of-informative-censoring">Assumption of Informative Censoring:</h4>
<p>We assume that the distribution of the effect modifier <span class="math inline">F</span> differs between the censored and uncensored populations:</p>
<p><span class="math display"> \Pr(F=f \mid C=0) \neq \Pr(F=f \mid C=1) </span></p>
<p>Under this assumption, the probability weights used to calculate the marginal effects for the uncensored and censored populations differ.</p>
</section>
<section id="effect-estimates-for-censored-and-uncensored-populations" class="level4">
<h4 class="anchored" data-anchor-id="effect-estimates-for-censored-and-uncensored-populations">Effect Estimates for Censored and Uncensored Populations:</h4>
<p>Given that <span class="math inline">\Pr(F=f \mid C=0) \neq \Pr(F=f \mid C=1)</span>, we cannot guarantee that:</p>
<p><span class="math display">
\Delta_{\text{uncensored}} = \Delta_{\text{censored}}
</span></p>
<p>The equality of marginal effects between the two populations will only hold if there is a universal null effect (i.e., no effect of the exposure on the outcome for any individual) across all units, by chance, or under specific conditions discussed by <span class="citation" data-cites="vanderweele2007">VanderWeele and Robins (<a href="#ref-vanderweele2007" role="doc-biblioref">2007</a>)</span> and further elucidated by <span class="citation" data-cites="suzuki2013counterfactual">Suzuki et al. (<a href="#ref-suzuki2013counterfactual" role="doc-biblioref">2013</a>)</span>. Otherwise:</p>
<p><span class="math display"> \Delta_{\text{uncensored}} \ne \Delta_{\text{censored}} </span></p>
<p>Furthermore, <span class="citation" data-cites="vanderweele2012">VanderWeele (<a href="#ref-vanderweele2012" role="doc-biblioref">2012</a>)</span> proved that if there is effect modification of <span class="math inline">A</span> by <span class="math inline">F</span>, there will be a difference in at least one scale of causal contrast, such that:</p>
<p><span class="math display"> \Delta^{\text{risk ratio}}_{\text{uncensored}} \ne \Delta^{\text{risk ratio}}_{\text{censored}} </span></p>
<p>or</p>
<p><span class="math display"> \Delta^{\text{difference}}_{\text{uncensored}} \ne \Delta^{\text{difference}}_{\text{censored}} </span></p>
<p>For comprehensive discussions on sampling and inference, refer to <span class="citation" data-cites="dahabreh2019">Issa J. Dahabreh and Hernán (<a href="#ref-dahabreh2019" role="doc-biblioref">2019</a>)</span> and <span class="citation" data-cites="dahabreh2021study">Issa J. Dahabreh et al. (<a href="#ref-dahabreh2021study" role="doc-biblioref">2021</a>)</span>. </p><div style="page-break-after: always;"></div> ## S4. R Simulation to Clarify Why The Distribution of Effect Modifiers Matters For Estimating Treatment Effects For A Target Population {#id-app-d}<p></p>
<p>First, we load the <code>stdReg</code> library, which obtains marginal effect estimates by simulating counterfactuals under different levels of treatment <span class="citation" data-cites="sjölander2016">(<a href="#ref-sjölander2016" role="doc-biblioref">Sjölander 2016</a>)</span>. If a treatment is continuous, the levels can be specified.</p>
<p>We also load the <code>parameters</code> library, which creates nice tables <span class="citation" data-cites="parameters2020">(<a href="#ref-parameters2020" role="doc-biblioref">Lüdecke et al. 2020</a>)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: loadlibs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># to obtain marginal effects</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">'stdReg'</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">'stdReg'</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stdReg)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  to view data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">'skimr'</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">'skimr'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># to create nice tables</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">'parameters'</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">'parameters'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parameters)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Next, we write a function to simulate data for the sample and target populations.</p>
<p>We assume the treatment effect is the same in the sample and target populations, that the coefficient for the effect modifier and the coefficient for interaction are the same, that there is no unmeasured confounding throughout the study, and that there is only selective attrition of one effect modifier such that the baseline population differs from the analytic sample population at the end of the study.</p>
<p>That is: <strong>the distribution of effect modifiers is the only respect in which the sample will differ from the target population.</strong></p>
<p>This function will generate data under a range of scenarios. Refer to documentation in the <code>margot</code> package: <span class="citation" data-cites="margot2024">Bulbulia (<a href="#ref-margot2024" role="doc-biblioref">2024a</a>)</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to generate data for the sample and population, </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Along with precise sample weights for the population, there are differences </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># in the distribution of the true effect modifier but no differences in the treatment effect </span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># or the effect modification. all that differs between the sample and the population is </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the distribution of effect modifiers.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># seed</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate data -- you can use different parameters</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">simulate_ate_data_with_weights</span>(</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sample =</span> <span class="dv">10000</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_population =</span> <span class="dv">100000</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_z_sample =</span> <span class="fl">0.1</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_z_population =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_a =</span> <span class="dv">1</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_z =</span> <span class="fl">2.5</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_sd =</span> <span class="fl">0.5</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># skimr::skim(data)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We have generated both sample and population data.</p>
<p>Next, we verify that the distributions of effect modifiers differ in the sample and in the target population:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain the generated data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> data<span class="sc">$</span>sample_data</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>population_data <span class="ot">&lt;-</span> data<span class="sc">$</span>population_data</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># check imbalance</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(sample_data<span class="sc">$</span>z_sample) <span class="co"># type 1 is rare</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
9041  959 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(population_data<span class="sc">$</span>z_population) <span class="co"># type 1 is common</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1 
49785 50215 </code></pre>
</div>
</div>
<p>The sample and population distributions differ.</p>
<p>Next, consider the question: ‘What are the differences in the coefficients that we obtain from the study population at the end of the study, compared with those we would obtain for the target population?’</p>
<p>First, we obtain the regression coefficients for the sample. They are as follows:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model coefficients sample</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>model_sample  <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_sample <span class="sc">~</span> a_sample <span class="sc">*</span> z_sample, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>parameters<span class="sc">::</span><span class="fu">model_parameters</span>(model_sample, <span class="at">ci_method =</span> <span class="st">'wald'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter           | Coefficient |       SE |        95% CI | t(9996) |      p
-------------------------------------------------------------------------------
(Intercept)         |   -2.10e-03 | 7.30e-03 | [-0.02, 0.01] |   -0.29 | 0.774 
a sample            |        1.00 |     0.01 | [ 0.98, 1.02] |   96.38 | &lt; .001
z sample            |        2.53 |     0.02 | [ 2.49, 2.58] |  107.68 | &lt; .001
a sample × z sample |        0.45 |     0.03 | [ 0.39, 0.52] |   13.46 | &lt; .001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Uncertainty intervals (equal-tailed) and p-values (two-tailed) computed
  using a Wald t-distribution approximation.</code></pre>
</div>
</div>
<p>Next, we obtain the regression coefficients for the weighted regression of the sample. Notice that the coefficients are virtually the same:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model the sample weighted to the population, again note that these coefficients are similar </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>model_weighted_sample <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_sample <span class="sc">~</span> a_sample <span class="sc">*</span> z_sample, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data, <span class="at">weights =</span> weights)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(parameters<span class="sc">::</span><span class="fu">model_parameters</span>(model_weighted_sample, </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_method =</span> <span class="st">'wald'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter           | Coefficient |        95% CI |      p
----------------------------------------------------------
(Intercept)         |   -2.10e-03 | [-0.02, 0.02] | 0.827 
a sample            |        1.00 | [ 0.97, 1.03] | &lt; .001
z sample            |        2.53 | [ 2.51, 2.56] | &lt; .001
a sample × z sample |        0.45 | [ 0.41, 0.49] | &lt; .001

Model: y_sample ~ a_sample * z_sample (10000 Observations)
Sigma: 0.483 (df = 9996)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Uncertainty intervals (equal-tailed) and p-values (two-tailed) computed
  using a Wald t-distribution approximation.</code></pre>
</div>
</div>
<p>We might be tempted to infer that weighting wasn’t relevant to the analysis. However, we’ll see that such an interpretation would be a mistake.</p>
<p>Next, we obtain model coefficients for the population. Note again there is no difference – only narrower errors owing to the large sample size.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model coefficients population -- note that these coefficients are very similar. </span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>model_population <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_population <span class="sc">~</span> a_population <span class="sc">*</span> z_population, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> population_data)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>parameters<span class="sc">::</span><span class="fu">model_parameters</span>(model_population, <span class="at">ci_method =</span> <span class="st">'wald'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter                   | Coefficient |       SE |        95% CI | t(99996) |      p
----------------------------------------------------------------------------------------
(Intercept)                 |   -7.10e-04 | 3.19e-03 | [-0.01, 0.01] |    -0.22 | 0.824 
a population                |        1.00 | 4.49e-03 | [ 0.99, 1.01] |   222.88 | &lt; .001
z population                |        2.50 | 4.49e-03 | [ 2.50, 2.51] |   557.23 | &lt; .001
a population × z population |        0.50 | 6.34e-03 | [ 0.49, 0.51] |    78.46 | &lt; .001</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Uncertainty intervals (equal-tailed) and p-values (two-tailed) computed
  using a Wald t-distribution approximation.</code></pre>
</div>
</div>
<p>Again, there is no difference. That is, we find that all model coefficients are practically equivalent. The different distribution of effect modifiers does not result in different coefficient values for the treatment effect, the effect-modifier ‘effect,’ or the interaction of the effect modifier and treatment.</p>
<p>Consider why this is the case: in a large sample where the causal effects are invariant – as we have simulated them to be – we will have good replication in the effect modifiers within the sample, so our statistical model can recover the <em>coefficients</em> for the population without challenge.</p>
<p>However, in causal inference, we are interested in the marginal effect of the treatment within a population of interest or within strata of this population. That is, we seek an estimate for the counterfactual contrast in which everyone in a pre-specified population or stratum of a population was subject to one level of treatment compared with a counterfactual condition in which everyone in a population was subject to another level of the same treatment.</p>
<p><strong>The marginal effect estimates will differ in at least one measure of effect when the analytic sample population has a different distribution of effect modifiers compared to the target population.</strong></p>
<p>To see this, we use the <code>stdReg</code> package to recover marginal effect estimates, comparing (1) the sample ATE, (2) the true oracle ATE for the population, and (3) the weighted sample ATE. We will use the outputs of the same models above. The only difference is that we will calculate marginal effects from these outputs. We will contrast a difference from an intervention in which everyone receives treatment = 0 with one in which everyone receives treatment = 1; however, this choice is arbitrary, and the general lessons apply irrespective of the estimand.</p>
<p>First, consider this Average Treatment Effect for the analytic population:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What inference do we draw?  </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we cannot say the models are unbiased for the marginal effect estimates. </span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># regression standardisation </span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stdReg) <span class="co"># to obtain marginal effects </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain sample ate</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>fit_std_sample <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(model_sample, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data, <span class="at">X =</span> <span class="st">'a_sample'</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_std_sample, <span class="at">contrast =</span> <span class="st">'difference'</span>, <span class="at">reference =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: y_sample ~ a_sample * z_sample
Family: gaussian 
Link function: identity 
Exposure:  a_sample 
Reference level:  a_sample = 0 
Contrast:  difference 

  Estimate Std. Error lower 0.95 upper 0.95
0     0.00    0.00000       0.00       0.00
1     1.04    0.00996       1.02       1.06</code></pre>
</div>
</div>
<p>The treatment effect is given as a 1.06 unit change in the outcome across the analytic population, with a confidence interval from 1.04 to 1.08.</p>
<p>Next, we obtain the true (oracle) treatment effect for the target population under the same intervention:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## note the population effect is different</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain true ate</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>fit_std_population <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(model_population, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> population_data, <span class="at">X =</span> <span class="st">'a_population'</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_std_population, <span class="at">contrast =</span> <span class="st">'difference'</span>, <span class="at">reference =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: y_population ~ a_population * z_population
Family: gaussian 
Link function: identity 
Exposure:  a_population 
Reference level:  a_population = 0 
Contrast:  difference 

  Estimate Std. Error lower 0.95 upper 0.95
0     0.00    0.00000       0.00       0.00
1     1.25    0.00327       1.24       1.26</code></pre>
</div>
</div>
<p>Note that the true treatment effect is a 1.25-unit change in the population, with a confidence bound between 1.24 and 1.26. This is well outside the ATE that we obtain from the analytic population!</p>
<p>Next, consider the ATE in the weighted regression, where the analytic sample was weighted to the target population’s true distribution of effect modifiers:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## next try weights adjusted ate where we correctly assign population weights to the sample</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fit_std_weighted_sample_weights <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(model_weighted_sample, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data, <span class="at">X =</span> <span class="st">'a_sample'</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this gives us the right answer</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_std_weighted_sample_weights, <span class="at">contrast =</span> <span class="st">'difference'</span>, <span class="at">reference =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: y_sample ~ a_sample * z_sample
Family: gaussian 
Link function: identity 
Exposure:  a_sample 
Reference level:  a_sample = 0 
Contrast:  difference 

  Estimate Std. Error lower 0.95 upper 0.95
0     0.00     0.0000       0.00       0.00
1     1.22     0.0165       1.19       1.25</code></pre>
</div>
</div>
<p>We find that we obtain the population-level causal effect estimate with accurate coverage by weighting the sample to the target population. So with appropriate weights, our results generalise from the sample to the target population.</p>
</section>
</section>
<section id="lessons" class="level2">
<h2 class="anchored" data-anchor-id="lessons">Lessons</h2>
<ul>
<li><strong>Regression coefficients do not clarify the problem of sample/target population mismatch</strong> — or selection bias as discussed in this manuscript.</li>
<li><strong>Investigators should not rely on regression coefficients alone</strong> when evaluating the biases that arise from sample attrition. This advice applies to both methods that authors use to investigate threats of bias. To implement this advice, authors must first take it themselves.</li>
<li><strong>Observed data are generally insufficient for assessing threats</strong>. Observed data do not clarify structural sources of bias, nor do they clarify effect-modification in the full counterfactual data condition where all receive the treatment and all do not receive the treatment (at the same level).</li>
<li><strong>To properly assess bias, one needs access to the counterfactual outcome</strong> — what would have happened to the missing participants had they not been lost to follow-up or had they responded? The joint distributions over ‘full data’ are inherently unobservable <span class="citation" data-cites="vanderlaan2011">(<a href="#ref-vanderlaan2011" role="doc-biblioref">Van Der Laan and Rose 2011</a>)</span>.</li>
<li><strong>In simple settings, like the one we just simulated, we can address the gap between the sample and target population using methods such as modelling the censoring (e.g., censoring weighting).</strong> However, we never know what setting we are in or whether it is simple—such modelling must be handled carefully. There is a large and growing epidemiology literature on this topic (see, for example, <span class="citation" data-cites="li2023non">Li, Miao, and Tchetgen Tchetgen (<a href="#ref-li2023non" role="doc-biblioref">2023</a>)</span>).</li>
</ul>
<hr>
</section>
<section id="ambiguities-from-cross-sectional-data" class="level2">
<h2 class="anchored" data-anchor-id="ambiguities-from-cross-sectional-data">Ambiguities from Cross-Sectional Data</h2>
<section id="methodology" class="level3">
<h3 class="anchored" data-anchor-id="methodology">Methodology</h3>
<p><strong>Data Generation</strong>: we simulate a dataset for 1,000 individuals, where e.g.&nbsp;degree of religious belief (<span class="math inline">A</span>) influences wealth (<span class="math inline">L</span>), which in turn affects charitable donations (<span class="math inline">Y</span>$). The simulation is based on predefined parameters that establish <span class="math inline">L</span> as a mediator between <span class="math inline">A</span> and <span class="math inline">Y</span>.</p>
<p><strong>Parameter Definitions</strong>:</p>
<ul>
<li>The probability of access to green space (<span class="math inline">A</span>) is set at 0.5.</li>
<li>The effect of <span class="math inline">A</span> on <span class="math inline">L</span> (exercise) is given by <span class="math inline">\beta = 2</span>.</li>
<li>The effect of <span class="math inline">L</span> on <span class="math inline">Y</span> (happiness) is given by <span class="math inline">\delta = 1.5</span>.</li>
<li>Standard deviations for <span class="math inline">L</span> and <span class="math inline">Y</span> are set at 1 and 1.5, respectively.</li>
</ul>
<p><strong>Model 1</strong> (Correct Assumption): fits a linear regression model assuming <span class="math inline">L</span> as a mediator, including both <span class="math inline">A</span> and <span class="math inline">L</span> as regressors on <span class="math inline">Y</span>. This model aligns with the data-generating process, and, by the rules of d-separation, induces mediator bias for the <span class="math inline">A\to Y</span> path.</p>
<p><strong>Model 2</strong> (Incorrect Assumption): fits a linear regression model including only <span class="math inline">A</span> as a regressor on <span class="math inline">Y</span>, omitting the mediator <span class="math inline">L</span>. This model assesses the direct effect of A on Y without accounting for mediation.</p>
<p><strong>Analysis</strong>: We compares the estimated effects of <span class="math inline">A</span> on <span class="math inline">Y</span> under each model specification.</p>
<div class="cell" data-tbl-cap="Code for a simulation of a data generating process in which the effect of wealth (L) fully mediates the effect of reliigious belief (A) on donations (Y).">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load libraries</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span><span class="fu">require</span>(kableExtra)<span class="er">)</span>{<span class="fu">install.packages</span>(<span class="st">"kableExtra"</span>)} <span class="co"># tables</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(gtsummary)){<span class="fu">install.packages</span>(<span class="st">"gtsummary"</span>)} <span class="co"># tables</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># simulation seed</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co">#  reproducibility</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># define the parameters </span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1000</span> <span class="co"># Number of observations</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fl">0.5</span>  <span class="co"># Probability of A = 1 (exposure)</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="dv">0</span> <span class="co"># Intercept for L (mediator)</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> <span class="dv">2</span>  <span class="co"># Effect of A on L </span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="dv">1</span> <span class="co"># Intercept for Y </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">=</span> <span class="fl">1.5</span> <span class="co"># Effect of L on Y</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>sigma_L <span class="ot">=</span> <span class="dv">1</span> <span class="co"># Standard deviation of L</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>sigma_Y <span class="ot">=</span> <span class="fl">1.5</span> <span class="co"># Standard deviation of Y</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate the data: fully mediated effect by L</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>A <span class="ot">=</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p) <span class="co"># binary exposure variable</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>L <span class="ot">=</span> alpha <span class="sc">+</span> beta<span class="sc">*</span>A <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, sigma_L) <span class="co"># mediator L affect by A</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> gamma <span class="sc">+</span> delta<span class="sc">*</span>L <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, sigma_Y) <span class="co"># Y affected only by L,</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co"># make the data frame</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">A =</span> A, <span class="at">L =</span> L, <span class="at">Y =</span> Y)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># fit regression in which we control for L, a mediator</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># (cross-sectional data is consistent with this model)</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> <span class="fu">lm</span>( Y <span class="sc">~</span> A <span class="sc">+</span> L, <span class="at">data =</span> data)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co"># fit regression in which L is assumed to be a mediator, not a confounder.</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># (cross-sectional data is also consistent with this model)</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>fit_2 <span class="ot">&lt;-</span> <span class="fu">lm</span>( Y <span class="sc">~</span> A, <span class="at">data =</span> data)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># create gtsummary tables for each regression model</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> gtsummary<span class="sc">::</span><span class="fu">tbl_regression</span>(fit_1)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> gtsummary<span class="sc">::</span><span class="fu">tbl_regression</span>(fit_2)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the tables for comparison</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>table_comparison <span class="ot">&lt;-</span> gtsummary<span class="sc">::</span><span class="fu">tbl_merge</span>(</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(table1, table2),</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">tab_spanner =</span> <span class="fu">c</span>(<span class="st">"Model: Exercise assumed confounder"</span>, </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Model: Exercise assumed to be a mediator"</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="co"># make html table (for publication)</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>markdown_table_0 <span class="ot">&lt;-</span> <span class="fu">as_kable_extra</span>(table_comparison, </span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">format =</span> <span class="st">"html"</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co"># print table (note, you might prefer "markdown" or another format)                                </span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>markdown_table_0</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The following code is designed to estimate the Average Treatment Effect (ATE) using the <code>clarify</code> package in R, which is referenced here as <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>. The procedure involves two steps: simulating coefficient distributions for regression models and then calculating the ATE based on these simulations. This process is applied to two distinct models to demonstrate the effects of including versus excluding a mediator variable in the analysis.</p>
</section>
<section id="steps-to-estimate-the-ate" class="level3">
<h3 class="anchored" data-anchor-id="steps-to-estimate-the-ate">Steps to Estimate the ATE</h3>
<ol type="1">
<li><p><strong>Load the <code>clarify</code> Package</strong>: this package provides functions to simulate regression coefficients and compute average marginal effects (AME), robustly facilitating the estimation of ATE.</p></li>
<li><p><strong>Set seed</strong>: <code>set.seed(123)</code> ensures that the results of the simulations are reproducible, allowing for consistent outcomes across different code runs.</p></li>
<li><p><strong>Simulate the data distribution</strong>:</p>
<p><code>sim_coefs_fit_1</code> and <code>sim_coefs_fit_2</code> are generated using the <code>sim</code> function from the <code>clarify</code> package, applied to two fitted models (<code>fit_1</code> and <code>fit_2</code>). These functions simulate the distribution of coefficients based on the specified models, capturing the uncertainty around the estimated parameters.</p></li>
<li><p><strong>Calculate ATE</strong>:</p></li>
</ol>
<p>For both models, the <code>sim_ame</code> function calculates the ATE as the marginal risk difference (RD) when the treatment variable (<code>A</code>) is present (<code>A == 1</code>). This function uses the simulated coefficients to estimate the treatment effect across the simulated distributions, providing a comprehensive view of the ATE under each model.</p>
<p>To streamline the output, the function is set to verbose mode off (<code>verbose = FALSE</code>).</p>
<ol start="5" type="1">
<li><strong>Results</strong>:</li>
</ol>
<p>Summaries of these estimates (<code>summary_sim_est_fit_1</code> and <code>summary_sim_est_fit_2</code>) are obtained, providing detailed statistics including the estimated ATE and its 95% confidence intervals (CI).</p>
<ol start="6" type="1">
<li><strong>Presentation: report ATE and CIs</strong>:</li>
</ol>
<p>Using the <code>glue</code> package, the ATE and its 95% CIs for both models are formatted into a string for easy reporting. This step transforms the statistical output into a more interpretable form, highlighting the estimated treatment effect and its precision.</p>
<div class="cell" data-tbl-cap="Code for calculating the average treatment effect as contrasts between simulated outcomes for the entire population.">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use `clarify` package to obtain ATE</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(clarify)){<span class="fu">install.packages</span>(<span class="st">"clarify"</span>)} <span class="co"># clarify package</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate fit 1 ATE</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_1 <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_1)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_2 <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_2)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 1 (L is a confounder)</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>sim_est_fit_1 <span class="ot">&lt;-</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_1,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 2 (L is a mediator)</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>sim_est_fit_2 <span class="ot">&lt;-</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_2,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A"</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain summaries</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(sim_est_fit_1, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(sim_est_fit_2, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co"># reporting </span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 1, with 95% CI</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>ATE_fit_1 <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE =</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="st">                        {round(summary_sim_est_fit_1[3, 1], 2)},</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="st">                        CI = [{round(summary_sim_est_fit_1[3, 2], 2)},</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="st">                        {round(summary_sim_est_fit_1[3, 3], 2)}]"</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 2, with 95% CI</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>ATE_fit_2 <span class="ot">&lt;-</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE = {round(summary_sim_est_fit_2[3, 1], 2)},</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="st">                        CI = [{round(summary_sim_est_fit_2[3, 2], 2)},</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="st">                        {round(summary_sim_est_fit_2[3, 3], 2)}]"</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="upshot-of-the-simulation-and-analysis" class="level3">
<h3 class="anchored" data-anchor-id="upshot-of-the-simulation-and-analysis">Upshot of the Simulation and Analysis</h3>
<ul>
<li><p><strong>Model 1 (L as a Confounder)</strong>: this analysis assumes that <code>L</code> is a confounder in the relationship between the treatment (<code>A</code>) and the outcome (<code>Y</code>), and thus, it includes <code>L</code> in the model. The ATE estimated here reflects the effect of <code>A</code> while controlling for <code>L</code>.</p></li>
<li><p><strong>Model 2 (L as a Mediator)</strong>: in contrast, this analysis considers <code>L</code> to be a mediator, and the model either includes <code>L</code> explicitly in its estimation process or excludes it to examine the direct effect of <code>A</code> on <code>Y</code>. The approach to mediation analysis here is crucial as it influences the interpretation of the ATE.</p></li>
</ul>
<p>By comparing the ATEs from both models, researchers can understand the effect of mediation (or the lack thereof) on the estimated treatment effect. This comparison sheds light on how assumptions about variable roles (confounder vs.&nbsp;mediator) can significantly alter causal inferences drawn from cross-sectional data.</p>
<p><strong>Wherever it is uncertain whether a variable is a confounder or a mediator, we suggest creating two causal diagrams and reporting both analyses.</strong></p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="appendix-d" class="level2">
<h2 class="anchored" data-anchor-id="appendix-d">Appendix D: Simulation of Different Confounding Control Strategies</h2>
<p>This appendix outlines the methodology and results of a data simulation designed to compare different strategies for controlling confounding in the context of environmental psychology research. Specifically, the simulation examines the effect of access to open green spaces (treatment, <span class="math inline">A_1</span>) on happiness (outcome, <span class="math inline">Y_2</span>) while addressing the challenge of unmeasured confounding. The simulation incorporates baseline measures of exposure and outcome (<span class="math inline">A_0</span>, <span class="math inline">Y_0</span>), baseline confounders (<span class="math inline">L_0</span>), and an unmeasured confounder (<span class="math inline">U</span>) to evaluate the effectiveness of different analytical approaches.</p>
<section id="methodology-1" class="level3">
<h3 class="anchored" data-anchor-id="methodology-1">Methodology</h3>
<p>1.<strong>Load Libraries <code>kableExtra</code>, <code>gtsummary</code>, and <code>grf</code>.</strong></p>
<ol type="1">
<li><p><strong>Target</strong>: we simulate data for 10,000 individuals, including baseline exposure to green spaces (<span class="math inline">A_0</span>), baseline happiness (<span class="math inline">Y_0</span>), baseline confounders (<span class="math inline">L_0</span>), and an unmeasured confounder (<span class="math inline">U</span>). The simulation uses a logistic model for treatment assignment and a linear model for the continuous outcome, incorporating interactions to assess how baseline characteristics modify the treatment effect.</p></li>
<li><p><strong>Set seed and simulate the data distribution</strong>:</p></li>
</ol>
<p>Treatment assignment coefficients: <span class="math inline">\beta_{A0} = 0.25</span>, <span class="math inline">\beta_{Y0} = 0.3</span>, <span class="math inline">\beta_{L0} = 0.2</span>, and <span class="math inline">\beta_{U} = 0.1</span>. Outcome model coefficients: <span class="math inline">\delta_{A1} = 0.3</span>, <span class="math inline">\delta_{Y0} = 0.9</span>, <span class="math inline">\delta_{A0} = 0.1</span>, <span class="math inline">\delta_{L0} = 0.3</span>, with an interaction effect (<span class="math inline">\theta_{A0Y0L0} = 0.5</span>) indicating the combined influence of baseline exposure, outcome, and confounders on the follow-up outcome.</p>
<ol start="3" type="1">
<li><p><strong>Model comparison</strong>:</p>
<ul>
<li><strong>No control model</strong>: estimates the effect of <span class="math inline">A_1</span> on <span class="math inline">Y_2</span> without controlling for any confounders.</li>
<li><strong>Standard covariate control model</strong>: controls for baseline confounders (<span class="math inline">L_0</span>) alongside treatment (<span class="math inline">A_1</span>).</li>
<li><strong>Baseline exposure and outcome model</strong>: extends the standard model by including baseline treatment and outcome (<span class="math inline">A_0</span>, <span class="math inline">Y_0</span>) and their interaction with <span class="math inline">L_0</span>.</li>
</ul></li>
<li><p><strong>Results</strong>: each model’s effectiveness in estimating the true treatment effect is assessed by comparing regression outputs. The simulation evaluates how well each model addresses the bias introduced by unmeasured confounding and the role of baseline characteristics in modifying treatment effects.</p></li>
<li><p><strong>Presentation</strong>: the results are synthesised in a comparative table, formatted using the <code>kableExtra</code> {<span class="citation" data-cites="zhu2021KableExtra">Zhu (<a href="#ref-zhu2021KableExtra" role="doc-biblioref">2021</a>)</span>] and <code>gtsummary</code> packages <span class="citation" data-cites="gtsummary2021">(<a href="#ref-gtsummary2021" role="doc-biblioref">Sjoberg et al. 2021</a>)</span>, highlighting the estimated treatment effects and their statistical significance across models.</p></li>
</ol>
<p>Overall, we use the simulation to illustrate the importance of incorporating baseline characteristics and their interactions to mitigate the influence of unmeasured confounding.</p>
<p>Here is the simulation/model code:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(kableExtra)){<span class="fu">install.packages</span>(<span class="st">"kableExtra"</span>)} <span class="co"># causal forest</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(gtsummary)){<span class="fu">install.packages</span>(<span class="st">"gtsummary"</span>)} <span class="co"># causal forest</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: gtsummary</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(grf)){<span class="fu">install.packages</span>(<span class="st">"grf"</span>)} <span class="co"># causal forest</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: grf</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'grf'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:parameters':

    get_scores</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># r_texmf()eproducibility</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set number of observations</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10000</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># baseline covariates</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n) <span class="co"># Unmeasured confounder</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>A_0 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(U)) <span class="co"># Baseline exposure</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>Y_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> U, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Baseline outcome</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>L_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> U, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Baseline confounders</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients for treatment assignment</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>beta_A0 <span class="ot">=</span> <span class="fl">0.25</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>beta_Y0 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>beta_L0 <span class="ot">=</span> <span class="fl">0.2</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>beta_U <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate treatment assignment</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>A_1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">+</span> </span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>                                    beta_A0 <span class="sc">*</span> A_0 <span class="sc">+</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>                                    beta_Y0 <span class="sc">*</span> Y_0 <span class="sc">+</span> </span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>                                    beta_L0 <span class="sc">*</span> L_0 <span class="sc">+</span> </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                                    beta_U <span class="sc">*</span> U))</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients for continuous outcome</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>delta_A1 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>delta_Y0 <span class="ot">=</span> <span class="fl">0.9</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>delta_A0 <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>delta_L0 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>theta_A0Y0L0 <span class="ot">=</span> <span class="fl">0.5</span> <span class="co"># Interaction effect between A_1 and L_0</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>delta_U <span class="ot">=</span> <span class="fl">0.05</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate continuous outcome including interaction</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>Y_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean =</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>               delta_A1 <span class="sc">*</span> A_1 <span class="sc">+</span> </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>               delta_Y0 <span class="sc">*</span> Y_0 <span class="sc">+</span> </span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>               delta_A0 <span class="sc">*</span> A_0 <span class="sc">+</span> </span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>               delta_L0 <span class="sc">*</span> L_0 <span class="sc">+</span> </span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>               theta_A0Y0L0 <span class="sc">*</span> Y_0 <span class="sc">*</span> </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>               A_0 <span class="sc">*</span> L_0 <span class="sc">+</span> </span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>               delta_U <span class="sc">*</span> U,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>             <span class="at">sd =</span> .<span class="dv">5</span>)</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="co"># assemble data frame</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Y_2, A_0, A_1, L_0, Y_0, U)</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="co"># model: no control</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>fit_no_control <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y_2 <span class="sc">~</span> A_1, <span class="at">data =</span> data)</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="co"># model: standard covariate control</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>fit_standard <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y_2 <span class="sc">~</span> A_1 <span class="sc">+</span> L_0, <span class="at">data =</span> data)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="co"># model: interaction with baseline confounders, and baseline outcome and exposure</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>fit_interaction  <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y_2 <span class="sc">~</span> A_1 <span class="sc">*</span> (L_0 <span class="sc">+</span> A_0 <span class="sc">+</span> Y_0), <span class="at">data =</span> data)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="co"># create gtsummary tables for each regression model</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>tbl_fit_no_control<span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(fit_no_control)  </span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>tbl_fit_standard <span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(fit_standard)</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>tbl_fit_interaction <span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(fit_interaction)</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a><span class="co"># get only the treatment variable</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>tbl_list_modified <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">list</span>(</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>  tbl_fit_no_control,</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>  tbl_fit_standard,</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>  tbl_fit_interaction),</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(tbl) {</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>  tbl <span class="sc">%&gt;%</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">modify_table_body</span>(<span class="sc">~</span> .x <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"A_1"</span>))</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a><span class="co"># merge tables</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>table_comparison <span class="ot">&lt;-</span> <span class="fu">tbl_merge</span>(</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbls =</span> tbl_list_modified,</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">tab_spanner =</span> <span class="fu">c</span>(</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Control"</span>,</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Standard"</span>,</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Interaction"</span>)</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">modify_table_styling</span>(</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">column =</span> <span class="fu">c</span>(p.value_1, p.value_2, p.value_3),</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">hide =</span> <span class="cn">TRUE</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a><span class="co"># markdown table for publication</span></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>markdown_table <span class="ot">&lt;-</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_kable_extra</span>(table_comparison, <span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(markdown_table)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;table style="NAborder-bottom: 0;"&gt;
 &lt;thead&gt;
&lt;tr&gt;
&lt;th style="empty-cells: hide;border-bottom:hidden;" colspan="1"&gt;&lt;/th&gt;
&lt;th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"&gt;&lt;div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; "&gt;No Control&lt;/div&gt;&lt;/th&gt;
&lt;th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"&gt;&lt;div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; "&gt;Standard&lt;/div&gt;&lt;/th&gt;
&lt;th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2"&gt;&lt;div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; "&gt;Interaction&lt;/div&gt;&lt;/th&gt;
&lt;/tr&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Characteristic &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; Beta &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 95% CI &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; Beta &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 95% CI &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; Beta &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 95% CI &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; A_1 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 1.5 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 1.5, 1.6 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.86 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.80, 0.93 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.25 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.20, 0.31 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;tfoot&gt;&lt;tr&gt;&lt;td style="padding: 0; " colspan="100%"&gt;
&lt;sup&gt;&lt;/sup&gt; Abbreviation: CI = Confidence Interval&lt;/td&gt;&lt;/tr&gt;&lt;/tfoot&gt;
&lt;/table&gt;</code></pre>
</div>
</div>
<p>Next, in the following code, we calculate the Average Treatment Effect (ATE) using simulation-based approaches for two distinct models: one with standard covariate control and another incorporating interaction. This approach leverages the <code>clarify</code> package in R, which facilitates the simulation and interpretation of estimated coefficients from linear models to derive ATEs under different modelling assumptions <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
<p>First, we use the <code>sim</code> function from the <code>clarify</code> package to generate simulated coefficient distributions for the standard model (<code>fit_standard</code>) and the interaction model (<code>fit_interaction</code>). This step is crucial for capturing the uncertainty in our estimates arising from sampling variability.</p>
<p>Next, we employ each model’s <code>sim_ame</code> function to compute the average marginal effects (AME), focusing on the treatment variable (<code>A_1</code>). The calculation is done under the assumption that all individuals are treated (i.e., <code>A_1 == 1</code>), and we specify the contrast type as “RD” (Risk Difference) to directly obtain the ATE (Average Treatment Effect). The <code>sim_ame</code> function simulates the treatment effect across the distribution of simulated coefficients, providing a robust estimate of the ATE and its variability.</p>
<p>The summaries of these simulations (<code>summary_sim_est_fit_std</code> and <code>summary_sim_est_fit_int</code>) are then extracted to provide concise estimates of the ATE along with 95% confidence intervals (CIs) for both the standard and interaction models. This step is essential for understanding the magnitude and precision of the treatment effects estimated by the models.</p>
<p>Finally, we use the <code>glue</code> package to format these estimates into a human-readable form, presenting the ATE and its corresponding 95% CIs for each model. This presentation facilitates clear communication of the estimated treatment effects, allowing for direct comparison between the models and highlighting the effect of including baseline characteristics and their interactions on estimating the ATE <span class="citation" data-cites="hester2022GLUE">(<a href="#ref-hester2022GLUE" role="doc-biblioref">Hester and Bryan 2022</a>)</span>.</p>
<p>This simulation-based approach to estimating the ATE underscores the importance of considering model complexity and the roles of confounders and mediators in causal inference analyses. By comparing the ATE estimates from different models, we can assess the sensitivity of our causal conclusions to various assumptions and modelling strategies.</p>
<div class="cell" data-tbl-cap="Code for calculating the average treatment effect.">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" data-lst-cap="Code."><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use `clarify` package to obtain ATE</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(clarify)){<span class="fu">install.packages</span>(<span class="st">"clarify"</span>)} <span class="co"># clarify package</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: clarify</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" data-lst-cap="Code."><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate fit 1 ATE</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_no_control<span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_no_control)  </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_std <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_standard)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_int <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_interaction)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, no controls</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>sim_est_fit_no_control <span class="ot">&lt;-</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_no_control,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A_1"</span>,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A_1 <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 1 (L is a confounder)</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>sim_est_fit_std <span class="ot">&lt;-</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_std,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A_1"</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A_1 <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 2 (L is a mediator)</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>sim_est_fit_int <span class="ot">&lt;-</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_int,</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A_1"</span>,</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A_1 <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain summaries</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>summary_sim_coefs_fit_no_control <span class="ot">&lt;-</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(sim_est_fit_no_control, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_std <span class="ot">&lt;-</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(sim_est_fit_std, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_int <span class="ot">&lt;-</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(sim_est_fit_int, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a><span class="co"># get coefficients for reporting</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 1, with 95% CI</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>ATE_fit_no_control  <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE = {round(summary_sim_coefs_fit_no_control[3, 1], 2)}, </span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="st">  CI = [{round(summary_sim_coefs_fit_no_control[3, 2], 2)},</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="st">  {round(summary_sim_coefs_fit_no_control[3, 3], 2)}]"</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 2, with 95% CI</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>ATE_fit_std <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE = {round(summary_sim_est_fit_std[3, 1], 2)}, </span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="st">  CI = [{round(summary_sim_est_fit_std[3, 2], 2)},</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a><span class="st">  {round(summary_sim_est_fit_std[3, 3], 2)}]"</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 3, with 95% CI</span></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>ATE_fit_int <span class="ot">&lt;-</span></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE = {round(summary_sim_est_fit_int[3, 1], 2)},</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a><span class="st">    CI = [{round(summary_sim_est_fit_int[3, 2], 2)},</span></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a><span class="st">    {round(summary_sim_est_fit_int[3, 3], 2)}]"</span></span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a><span class="co"># coefs they used in the manuscript</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Using the <code>clarify</code> package, we infer the ATE for the standard model is ATE = 0.86, CI = [0.8, 0.92].</p>
<p>Using the <code>clarify</code> package, we infer the ATE for the model that conditions on the baseline exposure and baseline outcome to be: ATE = 0.43, CI = [0.39, 0.47], which is close to the values supplied to the data-generating mechanism.</p>
<p><strong>Take-home message:</strong></p>
<p>The baseline exposure and baseline outcome are often the most important variables to include for confounding control. The baseline exposure also allows us to estimate an incident-exposure effect. For this reason, we should endeavour to obtain at least three waves of data such that these variables and other baseline confounders are included at time 0, the exposure is included at time 1, and the outcome is included at time 2.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="appendix-causal-forests" class="level2">
<h2 class="anchored" data-anchor-id="appendix-causal-forests">Appendix E: Non-parametric Estimation of Average Treatment Effects Using Causal Forests</h2>
<p>This appendix provides a practical example of estimating average treatment effects (ATE) using a non-parametric approach, specifically applying causal forests. Unlike traditional regression models, causal forests allow for estimating treatment effects without imposing strict assumptions about the form of the relationship between treatment, covariates, and outcomes. This flexibility makes them particularly useful for analysing complex datasets where the treatment effect may vary across observations.</p>
<section id="causal-forest-model-implementation" class="level4">
<h4 class="anchored" data-anchor-id="causal-forest-model-implementation">Causal Forest Model Implementation</h4>
<ol type="1">
<li><p><strong>Libraries</strong>: the implementation begins with loading the necessary R libraries: <code>grf</code> for estimating conditional and average treatment effects using causal forests and <code>glue</code> for formatting the results for reporting.</p></li>
<li><ol type="1">
<li><strong>Data generation</strong>: the code assumes the presence of a data frame <code>data</code> generated from the previous code snippet containing the variables:</li>
</ol>
<ul>
<li><code>A_1</code>: Treatment indicator.</li>
<li><code>L_0</code>: A covariate.</li>
<li><code>Y_2</code>: Outcome of interest.</li>
<li><code>A_0</code> and <code>Y_0</code>: Baseline exposure and outcome, respectively.</li>
</ul>
<p>Treatment (<code>W</code>) and outcome (<code>Y</code>) vectors are extracted from <code>data</code> alongside a matrix <code>X</code> that includes covariates and baseline characteristics.</p></li>
<li><p><strong>Causal Forest model</strong>: a causal forest model is fitted using the <code>causal_forest</code> function from the <code>grf</code> package <span class="citation" data-cites="grf2024">(<a href="#ref-grf2024" role="doc-biblioref">Tibshirani et al. 2024</a>)</span>. This function takes the covariate matrix <code>X</code>, the outcome vector <code>Y</code>, and the treatment vector <code>W</code> as inputs, and it returns a model object that can be used for further analysis.</p></li>
<li><p><strong>Average Treatment Effect estimation</strong>: the <code>average_treatment_effect</code> function computes the ATE from the fitted causal forest model. This step is crucial as it quantifies the overall effect of the treatment across the population, adjusting for covariates included in the model.</p></li>
<li><p><strong>Reporting</strong>: The estimated ATE and its standard error (se) are extracted and formatted for reporting using the <code>glue</code> package <span class="citation" data-cites="hester2022GLUE">(<a href="#ref-hester2022GLUE" role="doc-biblioref">Hester and Bryan 2022</a>)</span>. This facilitates clear communication of the results, showing the estimated effect size and its uncertainty.</p></li>
</ol>
</section>
<section id="key-takeaways" class="level4">
<h4 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h4>
<p>First, causal forests offer a robust way to estimate treatment effects without making parametric solid assumptions. This approach is particularly advantageous in settings where the treatment effect may vary with covariates or across different subpopulations.</p>
<p>Second, the model estimates the ATE as the difference in expected outcomes between treated and untreated units, averaged across the population. This estimate reflects the overall effect of the treatment, accounting for the distribution of covariates in the sample.</p>
<p>Third, we find that the estimated ATE by the causal forest model converges to the actual value used in the data-generating process (assumed to be 0.3). This demonstrates the effectiveness of causal forests in uncovering the true treatment effect from complex data.</p>
<p>This example underscores the utility of semi-parametric and non-parametric methods, such as causal forests, in causal inference analyses.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load causal forest library </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grf) <span class="co"># estimate conditional and average treatment effects</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue) <span class="co"># reporting </span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  'data' is our data frame with columns 'A_1' for treatment, 'L_0' for a covariate, and 'Y_2' for the outcome</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  we also have the baseline exposure 'A_0' and 'Y_0'</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  ensure W (treatment) and Y (outcome) are vectors</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data<span class="sc">$</span>A_1)  <span class="co"># Treatment</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data<span class="sc">$</span>Y_2)  <span class="co"># Outcome</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data[, <span class="fu">c</span>(<span class="st">"L_0"</span>, <span class="st">"A_0"</span>, <span class="st">"Y_0"</span>)])</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co"># fit causal forest model </span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>fit_causal_forest <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(X, Y, W)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the average treatment effect (ATE)</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> <span class="fu">average_treatment_effect</span>(fit_causal_forest)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co"># make data frame for reporting using "glue' </span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>ate<span class="ot">&lt;-</span> <span class="fu">data.frame</span>(ate)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ate for report</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>ATE_fit_causal_forest <span class="ot">&lt;-</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE = {round(ate[1, 1], 2)}, se = {round(ate[2, 1], 2)}"</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Causal forest estimates the average treatment effect as ATE = 0.3, se = 0.01. This approach converges to the true value supplied to the generating mechanism of 0.3</p>
</section>
</section>
<section id="section" class="level2">



<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-bareinboim2013general" class="csl-entry" role="listitem">
Bareinboim, Elias, and Judea Pearl. 2013. <span>“A General Algorithm for Deciding Transportability of Experimental Results.”</span> <em>Journal of Causal Inference</em> 1 (1): 107–34.
</div>
<div id="ref-margot2024" class="csl-entry" role="listitem">
Bulbulia, J. A. 2024a. <em>Margot: MARGinal Observational Treatment-Effects</em>. <a href="https://doi.org/10.5281/zenodo.10907724">https://doi.org/10.5281/zenodo.10907724</a>.
</div>
<div id="ref-bulbulia2024wierd" class="csl-entry" role="listitem">
———. 2024b. <span>“Methods in Causal Inference Part 3: Measurement Error and External Validity Threats.”</span> <em>Evolutionary Human Sciences</em> 6: e42. <a href="https://doi.org/10.1017/ehs.2024.33">https://doi.org/10.1017/ehs.2024.33</a>.
</div>
<div id="ref-dahabreh2021study" class="csl-entry" role="listitem">
Dahabreh, Issa J, Sebastien JP A Haneuse, James M Robins, Sarah E Robertson, Ashley L Buchanan, Elizabeth A Stuart, and Miguel A Hernán. 2021. <span>“Study Designs for Extending Causal Inferences from a Randomized Trial to a Target Population.”</span> <em>American Journal of Epidemiology</em> 190 (8): 1632–42.
</div>
<div id="ref-dahabreh2019" class="csl-entry" role="listitem">
Dahabreh, Issa J., and Miguel A. Hernán. 2019. <span>“Extending Inferences from a Randomized Trial to a Target Population.”</span> <em>European Journal of Epidemiology</em> 34 (8): 719–22. <a href="https://doi.org/10.1007/s10654-019-00533-2">https://doi.org/10.1007/s10654-019-00533-2</a>.
</div>
<div id="ref-dahabreh2019generalizing" class="csl-entry" role="listitem">
Dahabreh, Issa J, James M Robins, Sebastien JP Haneuse, and Miguel A Hernán. 2019. <span>“Generalizing Causal Inferences from Randomized Trials: Counterfactual and Graphical Identification.”</span> <em>arXiv Preprint arXiv:1906.10792</em>.
</div>
<div id="ref-deffner2022" class="csl-entry" role="listitem">
Deffner, Dominik, Julia M. Rohrer, and Richard McElreath. 2022. <span>“A Causal Framework for Cross-Cultural Generalizability.”</span> <em>Advances in Methods and Practices in Psychological Science</em> 5 (3): 25152459221106366. <a href="https://doi.org/10.1177/25152459221106366">https://doi.org/10.1177/25152459221106366</a>.
</div>
<div id="ref-greifer2023" class="csl-entry" role="listitem">
Greifer, Noah, Steven Worthington, Stefano Iacus, and Gary King. 2023. <em>Clarify: Simulation-Based Inference for Regression Models</em>. <a href="https://iqss.github.io/clarify/">https://iqss.github.io/clarify/</a>.
</div>
<div id="ref-hester2022GLUE" class="csl-entry" role="listitem">
Hester, Jim, and Jennifer Bryan. 2022. <em>Glue: Interpreted String Literals</em>. <a href="https://CRAN.R-project.org/package=glue">https://CRAN.R-project.org/package=glue</a>.
</div>
<div id="ref-li2023non" class="csl-entry" role="listitem">
Li, Wei, Wang Miao, and Eric Tchetgen Tchetgen. 2023. <span>“Non-Parametric Inference about Mean Functionals of Non-Ignorable Non-Response Data Without Identifying the Joint Distribution.”</span> <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em> 85 (3): 913–35.
</div>
<div id="ref-parameters2020" class="csl-entry" role="listitem">
Lüdecke, Daniel, Mattan S. Ben-Shachar, Indrajeet Patil, and Dominique Makowski. 2020. <span>“Extracting, Computing and Exploring the Parameters of Statistical Models Using <span>R</span>.”</span> <em>Journal of Open Source Software</em> 5 (53): 2445. <a href="https://doi.org/10.21105/joss.02445">https://doi.org/10.21105/joss.02445</a>.
</div>
<div id="ref-gtsummary2021" class="csl-entry" role="listitem">
Sjoberg, Daniel D., Karissa Whiting, Michael Curry, Jessica A. Lavery, and Joseph Larmarange. 2021. <span>“Reproducible Summary Tables with the Gtsummary Package.”</span> <em><span>The R Journal</span></em> 13: 570–80. <a href="https://doi.org/10.32614/RJ-2021-053">https://doi.org/10.32614/RJ-2021-053</a>.
</div>
<div id="ref-sjölander2016" class="csl-entry" role="listitem">
Sjölander, Arvid. 2016. <span>“Regression Standardization with the R Package stdReg.”</span> <em>European Journal of Epidemiology</em> 31 (6): 563–74. <a href="https://doi.org/10.1007/s10654-016-0157-3">https://doi.org/10.1007/s10654-016-0157-3</a>.
</div>
<div id="ref-suzuki2013counterfactual" class="csl-entry" role="listitem">
Suzuki, Etsuji, Toshiharu Mitsuhashi, Toshihide Tsuda, and Eiji Yamamoto. 2013. <span>“A Counterfactual Approach to Bias and Effect Modification in Terms of Response Types.”</span> <em>BMC Medical Research Methodology</em> 13 (1): 1–17.
</div>
<div id="ref-grf2024" class="csl-entry" role="listitem">
Tibshirani, Julie, Susan Athey, Erik Sverdrup, and Stefan Wager. 2024. <em>Grf: Generalized Random Forests</em>. <a href="https://github.com/grf-labs/grf">https://github.com/grf-labs/grf</a>.
</div>
<div id="ref-vanderlaan2011" class="csl-entry" role="listitem">
Van Der Laan, Mark J., and Sherri Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. New York, NY: Springer. <a href="https://link.springer.com/10.1007/978-1-4419-9782-1">https://link.springer.com/10.1007/978-1-4419-9782-1</a>.
</div>
<div id="ref-vanderweele2012" class="csl-entry" role="listitem">
VanderWeele, Tyler J. 2012. <span>“Confounding and Effect Modification: Distribution and Measure.”</span> <em>Epidemiologic Methods</em> 1 (1): 55–82. <a href="https://doi.org/10.1515/2161-962X.1004">https://doi.org/10.1515/2161-962X.1004</a>.
</div>
<div id="ref-vanderweele2007" class="csl-entry" role="listitem">
VanderWeele, Tyler J., and James M. Robins. 2007. <span>“Four types of effect modification: a classification based on directed acyclic graphs.”</span> <em>Epidemiology (Cambridge, Mass.)</em> 18 (5): 561–68. <a href="https://doi.org/10.1097/EDE.0b013e318127181b">https://doi.org/10.1097/EDE.0b013e318127181b</a>.
</div>
<div id="ref-westreich2017transportability" class="csl-entry" role="listitem">
Westreich, Daniel, Jessie K Edwards, Catherine R Lesko, Elizabeth Stuart, and Stephen R Cole. 2017. <span>“Transportability of Trial Results Using Inverse Odds of Sampling Weights.”</span> <em>American Journal of Epidemiology</em> 186 (8): 1010–14.
</div>
<div id="ref-zhu2021KableExtra" class="csl-entry" role="listitem">
Zhu, Hao. 2021. <em>kableExtra: Construct Complex Table with ’Kable’ and Pipe Syntax</em>. <a href="https://CRAN.R-project.org/package=kableExtra">https://CRAN.R-project.org/package=kableExtra</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Simulation: Population Estimate"</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> |</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> /Users/joseph/GIT/templates/bib/references.bib</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">    warnings: FALSE</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">    error: FALSE</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">    messages: FALSE</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: kate</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools:</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co">      source: true</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: false</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="an">html-math-method:</span><span class="co"> katex</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="an">cap-location:</span><span class="co"> margin</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-libraries</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="co">#  fig-pos: 'htb'</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="co">#   html:</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="co">#    html-math-method: katex</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Include in YAML for Latex</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="co"># sanitize: true</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="co"># keep-tex: true</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="co"># include-in-header:</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="co">#       - text: |</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="co">#           \usepackage{cancel}</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="co"># for making graphs</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tinytex"</span>)</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"all"</span>)</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a><span class="co"># libraries for jb (when internet is not accessible)</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a><span class="co"># read libraries</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"/Users/joseph/GIT/templates/functions/libs2.R"</span>)</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="co"># read functions</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"/Users/joseph/GIT/templates/functions/funs.R"</span>)</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a><span class="co"># read data/ set to path in your computer</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>pull_path <span class="ot">&lt;-</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>  fs<span class="sc">::</span><span class="fu">path_expand</span>(</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/Users/joseph/v-project\ Dropbox/data/current/nzavs_13_arrow"</span></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a><span class="co"># for saving models. # set path fo your computer</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>push_mods <span class="ot">&lt;-</span></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>  fs<span class="sc">::</span><span class="fu">path_expand</span>(</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/Users/joseph/v-project\ Dropbox/data/nzvs_mods/00drafts/23-causal-dags"</span></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a><span class="co"># keywords: potential outcomes, DAGs, causal inference, evolution, religion, measurement, tutorial</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 10.31234/osf.io/b23k7</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulations</span></span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>S2 and S3 are from the supplement to @bulbulia2024wierd. S2 is a simulation. It illustrates how, if the distribution of effect-modifiers in one's sample differs from that of the target population, the marginal effect estimate (ATE) will be biased. S3 offers a mathmatical explanation for this result. These simulations are followed by others that clarify how inference may fail when the true timing of events in one's measures differs from what is assumed.</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a><span class="fu">## S2. Generalisability and Transportability {#id-app-b}</span></span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>Generalisability: When a study sample is drawn randomly from the target population, we may generalise from the sample to the target population as follows.</span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>Suppose we sample randomly from the target population, where:</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$n_S$ denotes the size of the study's analytic sample $S$.</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$N_T$ denotes the total size of the target population $T$.</span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\widehat{ATE}_{n_S}$ denotes the estimated average treatment effect in the analytic sample $S$.</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$ATE_{T}$ denotes the true average treatment effect in the target population $T$.</span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\epsilon$ denotes an arbitrarily small positive value.</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a>Assuming the rest of the causal inference workflow goes to plan (randomisation succeeds, there is no measurement error, no model misspecification, etc.), as the random sample size $n_S$ increases, the estimated treatment effect in the analytic sample $S$ converges in probability to the true treatment effect in the target population $T$:</span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a>\lim_{n_S \to \infty} P(|\widehat{ATE}_{n_S} - ATE_{T}| &lt; \epsilon) = 1</span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a>for any small positive value of $\epsilon$.</span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a>Transportability: When the analytic sample is not drawn from the target population, we cannot directly generalise the findings. However, we can transport the estimated causal effect from the source population to the target population under certain assumptions. This involves adjusting for differences in the distributions of effect modifiers between the two populations. The closer the source population is to the target population, the more plausible the transportability assumptions are, and the less we need to rely on complex adjustment methods.</span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a>Suppose we have an analytic sample $n_S$ drawn from a source population $S$, and we want to estimate the average treatment effect in a target population $T$.</span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a>Define:</span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a>$\widehat{ATE}_{S}$ as the estimated average treatment effect in the analytic sample drawn from the source population $S$.</span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a>$\widehat{ATE}_{T}$ as the estimated average treatment effect in the target population $T$.</span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a>$f(n_S, R)$ as the mapping function that adjusts the estimated effect in the analytic sample using a set of measured covariates $R$, allowing for valid projection from the source population to the target population.</span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a>The transportability assumption is that there exists a function $f$ such that:</span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a>\widehat{ATE}_{T} = f(\widehat{ATE}_S, R)</span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a>Here, $\widehat{ATE}_S$ is the estimated average treatment effect from the source population, and $R$ represents the set of covariates used for adjustment.</span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a>Finding a suitable function $f$ is the central challenge in adjusting for sampling bias and achieving transportability <span class="co">[</span><span class="ot">@bareinboim2013general; @westreich2017transportability; @dahabreh2019generalizing; @deffner2022</span><span class="co">]</span>.</span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a>{{&lt; pagebreak &gt;}}</span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a><span class="fu">## S3. A Mathematical Explanation for the Difference in Marginal Effects between Censored and Uncensored Populations {#id-app-c}</span></span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a>This appendix provides an explanation for why marginal effects may differ between the censored and uncensored sample population in the absence of unmeasured confounding.</span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Definitions:</span></span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$A$**: Exposure variable, where $a$ represents the reference level and $a^*$ represents the comparison level</span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$Y$**: Outcome variable</span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$F$**: Effect modifier</span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$C$**: Indicator for the uncensored population ($C = 0$) or the censored population ($C = 1$)</span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Average Treatment Effects:</span></span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-128"><a href="#cb36-128" aria-hidden="true" tabindex="-1"></a>The average treatment effects for the uncensored and censored populations are defined as:</span>
<span id="cb36-129"><a href="#cb36-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a>$$ \Delta_{\text{uncensored}} = \mathbb{E}<span class="co">[</span><span class="ot">Y(a^*) - Y(a) \mid C = 0</span><span class="co">]</span> $$</span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a>$$ \Delta_{\text{censored}} = \mathbb{E}<span class="co">[</span><span class="ot">Y(a^*) - Y(a) \mid C = 1</span><span class="co">]</span> $$</span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Potential Outcomes:</span></span>
<span id="cb36-135"><a href="#cb36-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-136"><a href="#cb36-136" aria-hidden="true" tabindex="-1"></a>By causal consistency, potential outcomes can be expressed in terms of observed outcomes:</span>
<span id="cb36-137"><a href="#cb36-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-138"><a href="#cb36-138" aria-hidden="true" tabindex="-1"></a>$$ \Delta_{\text{uncensored}} = \mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a^*, C=0</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a, C=0</span><span class="co">]</span> $$</span>
<span id="cb36-139"><a href="#cb36-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-140"><a href="#cb36-140" aria-hidden="true" tabindex="-1"></a>$$ \Delta_{\text{censored}} = \mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a^*, C=1</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a, C=1</span><span class="co">]</span> $$</span>
<span id="cb36-141"><a href="#cb36-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-142"><a href="#cb36-142" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Law of Total Probability:</span></span>
<span id="cb36-143"><a href="#cb36-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-144"><a href="#cb36-144" aria-hidden="true" tabindex="-1"></a>Applying the Law of Total Probability, we can weight the average treatment effects by the conditional probability of the effect modifier $F$:</span>
<span id="cb36-145"><a href="#cb36-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-146"><a href="#cb36-146" aria-hidden="true" tabindex="-1"></a>$$ \Delta_{\text{uncensored}} = \sum_{f} \Big<span class="sc">\{</span>\mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a^*, F=f, C=0</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a, F=f, C=0</span><span class="co">]</span>\Big<span class="sc">\}</span> \times \Pr(F=f \mid C=0) $$</span>
<span id="cb36-147"><a href="#cb36-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-148"><a href="#cb36-148" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb36-149"><a href="#cb36-149" aria-hidden="true" tabindex="-1"></a>\Delta_{\text{censored}} = \sum_{f} \Big<span class="sc">\{</span>\mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a^*, F=f, C=1</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">Y \mid A=a, F=f, C=1</span><span class="co">]</span>\Big<span class="sc">\}</span> \times \Pr(F=f \mid C=1) </span>
<span id="cb36-150"><a href="#cb36-150" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb36-151"><a href="#cb36-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-152"><a href="#cb36-152" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Assumption of Informative Censoring:</span></span>
<span id="cb36-153"><a href="#cb36-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-154"><a href="#cb36-154" aria-hidden="true" tabindex="-1"></a>We assume that the distribution of the effect modifier $F$ differs between the censored and uncensored populations:</span>
<span id="cb36-155"><a href="#cb36-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-156"><a href="#cb36-156" aria-hidden="true" tabindex="-1"></a>$$ \Pr(F=f \mid C=0) \neq \Pr(F=f \mid C=1) $$</span>
<span id="cb36-157"><a href="#cb36-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-158"><a href="#cb36-158" aria-hidden="true" tabindex="-1"></a>Under this assumption, the probability weights used to calculate the marginal effects for the uncensored and censored populations differ.</span>
<span id="cb36-159"><a href="#cb36-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-160"><a href="#cb36-160" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Effect Estimates for Censored and Uncensored Populations:</span></span>
<span id="cb36-161"><a href="#cb36-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-162"><a href="#cb36-162" aria-hidden="true" tabindex="-1"></a>Given that $\Pr(F=f \mid C=0) \neq \Pr(F=f \mid C=1)$, we cannot guarantee that:</span>
<span id="cb36-163"><a href="#cb36-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-164"><a href="#cb36-164" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb36-165"><a href="#cb36-165" aria-hidden="true" tabindex="-1"></a>\Delta_{\text{uncensored}} = \Delta_{\text{censored}} </span>
<span id="cb36-166"><a href="#cb36-166" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb36-167"><a href="#cb36-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-168"><a href="#cb36-168" aria-hidden="true" tabindex="-1"></a>The equality of marginal effects between the two populations will only hold if there is a universal null effect (i.e., no effect of the exposure on the outcome for any individual) across all units, by chance, or under specific conditions discussed by @vanderweele2007 and further elucidated by @suzuki2013counterfactual. Otherwise:</span>
<span id="cb36-169"><a href="#cb36-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-170"><a href="#cb36-170" aria-hidden="true" tabindex="-1"></a>$$ \Delta_{\text{uncensored}} \ne \Delta_{\text{censored}} $$</span>
<span id="cb36-171"><a href="#cb36-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-172"><a href="#cb36-172" aria-hidden="true" tabindex="-1"></a>Furthermore, @vanderweele2012 proved that if there is effect modification of $A$ by $F$, there will be a difference in at least one scale of causal contrast, such that:</span>
<span id="cb36-173"><a href="#cb36-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-174"><a href="#cb36-174" aria-hidden="true" tabindex="-1"></a>$$ \Delta^{\text{risk ratio}}_{\text{uncensored}} \ne \Delta^{\text{risk ratio}}_{\text{censored}} $$</span>
<span id="cb36-175"><a href="#cb36-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-176"><a href="#cb36-176" aria-hidden="true" tabindex="-1"></a>or</span>
<span id="cb36-177"><a href="#cb36-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-178"><a href="#cb36-178" aria-hidden="true" tabindex="-1"></a>$$ \Delta^{\text{difference}}_{\text{uncensored}} \ne \Delta^{\text{difference}}_{\text{censored}} $$</span>
<span id="cb36-179"><a href="#cb36-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-180"><a href="#cb36-180" aria-hidden="true" tabindex="-1"></a>For comprehensive discussions on sampling and inference, refer to @dahabreh2019 and @dahabreh2021study.</span>
<span id="cb36-181"><a href="#cb36-181" aria-hidden="true" tabindex="-1"></a>{{&lt; pagebreak &gt;}}</span>
<span id="cb36-182"><a href="#cb36-182" aria-hidden="true" tabindex="-1"></a><span class="fu">## S4. R Simulation to Clarify Why The Distribution of Effect Modifiers Matters For Estimating Treatment Effects For A Target Population  {#id-app-d}</span></span>
<span id="cb36-183"><a href="#cb36-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-184"><a href="#cb36-184" aria-hidden="true" tabindex="-1"></a>First, we load the <span class="in">`stdReg`</span> library, which obtains marginal effect estimates by simulating counterfactuals under different levels of treatment <span class="co">[</span><span class="ot">@sjölander2016</span><span class="co">]</span>. If a treatment is continuous, the levels can be specified.</span>
<span id="cb36-185"><a href="#cb36-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-186"><a href="#cb36-186" aria-hidden="true" tabindex="-1"></a>We also load the <span class="in">`parameters`</span> library, which creates nice tables <span class="co">[</span><span class="ot">@parameters2020</span><span class="co">]</span>.</span>
<span id="cb36-187"><a href="#cb36-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-190"><a href="#cb36-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-191"><a href="#cb36-191" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: loadlibs</span></span>
<span id="cb36-192"><a href="#cb36-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-193"><a href="#cb36-193" aria-hidden="true" tabindex="-1"></a><span class="co"># to obtain marginal effects</span></span>
<span id="cb36-194"><a href="#cb36-194" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">'stdReg'</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">'stdReg'</span>)</span>
<span id="cb36-195"><a href="#cb36-195" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stdReg)</span>
<span id="cb36-196"><a href="#cb36-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-197"><a href="#cb36-197" aria-hidden="true" tabindex="-1"></a><span class="co">#  to view data</span></span>
<span id="cb36-198"><a href="#cb36-198" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">'skimr'</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">'skimr'</span>)</span>
<span id="cb36-199"><a href="#cb36-199" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb36-200"><a href="#cb36-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-201"><a href="#cb36-201" aria-hidden="true" tabindex="-1"></a><span class="co"># to create nice tables</span></span>
<span id="cb36-202"><a href="#cb36-202" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">'parameters'</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">'parameters'</span>)</span>
<span id="cb36-203"><a href="#cb36-203" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parameters)</span>
<span id="cb36-204"><a href="#cb36-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-205"><a href="#cb36-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-206"><a href="#cb36-206" aria-hidden="true" tabindex="-1"></a>Next, we write a function to simulate data for the sample and target populations.</span>
<span id="cb36-207"><a href="#cb36-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-208"><a href="#cb36-208" aria-hidden="true" tabindex="-1"></a>We assume the treatment effect is the same in the sample and target populations, that the coefficient for the effect modifier and the coefficient for interaction are the same, that there is no unmeasured confounding throughout the study, and that there is only selective attrition of one effect modifier such that the baseline population differs from the analytic sample population at the end of the study.</span>
<span id="cb36-209"><a href="#cb36-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-210"><a href="#cb36-210" aria-hidden="true" tabindex="-1"></a>That is: **the distribution of effect modifiers is the only respect in which the sample will differ from the target population.**</span>
<span id="cb36-211"><a href="#cb36-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-212"><a href="#cb36-212" aria-hidden="true" tabindex="-1"></a>This function will generate data under a range of scenarios. Refer to documentation in the <span class="in">`margot`</span> package: @margot2024</span>
<span id="cb36-213"><a href="#cb36-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-216"><a href="#cb36-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-217"><a href="#cb36-217" aria-hidden="true" tabindex="-1"></a><span class="co"># function to generate data for the sample and population, </span></span>
<span id="cb36-218"><a href="#cb36-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Along with precise sample weights for the population, there are differences </span></span>
<span id="cb36-219"><a href="#cb36-219" aria-hidden="true" tabindex="-1"></a><span class="co"># in the distribution of the true effect modifier but no differences in the treatment effect </span></span>
<span id="cb36-220"><a href="#cb36-220" aria-hidden="true" tabindex="-1"></a><span class="co"># or the effect modification. all that differs between the sample and the population is </span></span>
<span id="cb36-221"><a href="#cb36-221" aria-hidden="true" tabindex="-1"></a><span class="co"># the distribution of effect modifiers.</span></span>
<span id="cb36-222"><a href="#cb36-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-223"><a href="#cb36-223" aria-hidden="true" tabindex="-1"></a><span class="co"># seed</span></span>
<span id="cb36-224"><a href="#cb36-224" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb36-225"><a href="#cb36-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-226"><a href="#cb36-226" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate data -- you can use different parameters</span></span>
<span id="cb36-227"><a href="#cb36-227" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">simulate_ate_data_with_weights</span>(</span>
<span id="cb36-228"><a href="#cb36-228" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_sample =</span> <span class="dv">10000</span>,</span>
<span id="cb36-229"><a href="#cb36-229" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_population =</span> <span class="dv">100000</span>,</span>
<span id="cb36-230"><a href="#cb36-230" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_z_sample =</span> <span class="fl">0.1</span>,</span>
<span id="cb36-231"><a href="#cb36-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_z_population =</span> <span class="fl">0.5</span>,</span>
<span id="cb36-232"><a href="#cb36-232" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_a =</span> <span class="dv">1</span>,</span>
<span id="cb36-233"><a href="#cb36-233" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_z =</span> <span class="fl">2.5</span>,</span>
<span id="cb36-234"><a href="#cb36-234" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_sd =</span> <span class="fl">0.5</span></span>
<span id="cb36-235"><a href="#cb36-235" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-236"><a href="#cb36-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-237"><a href="#cb36-237" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect</span></span>
<span id="cb36-238"><a href="#cb36-238" aria-hidden="true" tabindex="-1"></a><span class="co"># skimr::skim(data)</span></span>
<span id="cb36-239"><a href="#cb36-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-240"><a href="#cb36-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-241"><a href="#cb36-241" aria-hidden="true" tabindex="-1"></a>We have generated both sample and population data.</span>
<span id="cb36-242"><a href="#cb36-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-243"><a href="#cb36-243" aria-hidden="true" tabindex="-1"></a>Next, we verify that the distributions of effect modifiers differ in the sample and in the target population:</span>
<span id="cb36-244"><a href="#cb36-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-247"><a href="#cb36-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-248"><a href="#cb36-248" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain the generated data</span></span>
<span id="cb36-249"><a href="#cb36-249" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> data<span class="sc">$</span>sample_data</span>
<span id="cb36-250"><a href="#cb36-250" aria-hidden="true" tabindex="-1"></a>population_data <span class="ot">&lt;-</span> data<span class="sc">$</span>population_data</span>
<span id="cb36-251"><a href="#cb36-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-252"><a href="#cb36-252" aria-hidden="true" tabindex="-1"></a><span class="co"># check imbalance</span></span>
<span id="cb36-253"><a href="#cb36-253" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(sample_data<span class="sc">$</span>z_sample) <span class="co"># type 1 is rare</span></span>
<span id="cb36-254"><a href="#cb36-254" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(population_data<span class="sc">$</span>z_population) <span class="co"># type 1 is common</span></span>
<span id="cb36-255"><a href="#cb36-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-256"><a href="#cb36-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-257"><a href="#cb36-257" aria-hidden="true" tabindex="-1"></a>The sample and population distributions differ.</span>
<span id="cb36-258"><a href="#cb36-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-259"><a href="#cb36-259" aria-hidden="true" tabindex="-1"></a>Next, consider the question: 'What are the differences in the coefficients that we obtain from the study population at the end of the study, compared with those we would obtain for the target population?'</span>
<span id="cb36-260"><a href="#cb36-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-261"><a href="#cb36-261" aria-hidden="true" tabindex="-1"></a>First, we obtain the regression coefficients for the sample. They are as follows:</span>
<span id="cb36-262"><a href="#cb36-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-265"><a href="#cb36-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-266"><a href="#cb36-266" aria-hidden="true" tabindex="-1"></a><span class="co"># model coefficients sample</span></span>
<span id="cb36-267"><a href="#cb36-267" aria-hidden="true" tabindex="-1"></a>model_sample  <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_sample <span class="sc">~</span> a_sample <span class="sc">*</span> z_sample, </span>
<span id="cb36-268"><a href="#cb36-268" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data)</span>
<span id="cb36-269"><a href="#cb36-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-270"><a href="#cb36-270" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb36-271"><a href="#cb36-271" aria-hidden="true" tabindex="-1"></a>parameters<span class="sc">::</span><span class="fu">model_parameters</span>(model_sample, <span class="at">ci_method =</span> <span class="st">'wald'</span>)</span>
<span id="cb36-272"><a href="#cb36-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-273"><a href="#cb36-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-274"><a href="#cb36-274" aria-hidden="true" tabindex="-1"></a>Next, we obtain the regression coefficients for the weighted regression of the sample. Notice that the coefficients are virtually the same:</span>
<span id="cb36-275"><a href="#cb36-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-278"><a href="#cb36-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-279"><a href="#cb36-279" aria-hidden="true" tabindex="-1"></a><span class="co"># model the sample weighted to the population, again note that these coefficients are similar </span></span>
<span id="cb36-280"><a href="#cb36-280" aria-hidden="true" tabindex="-1"></a>model_weighted_sample <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_sample <span class="sc">~</span> a_sample <span class="sc">*</span> z_sample, </span>
<span id="cb36-281"><a href="#cb36-281" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data, <span class="at">weights =</span> weights)</span>
<span id="cb36-282"><a href="#cb36-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-283"><a href="#cb36-283" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb36-284"><a href="#cb36-284" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(parameters<span class="sc">::</span><span class="fu">model_parameters</span>(model_weighted_sample, </span>
<span id="cb36-285"><a href="#cb36-285" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_method =</span> <span class="st">'wald'</span>))</span>
<span id="cb36-286"><a href="#cb36-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-287"><a href="#cb36-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-288"><a href="#cb36-288" aria-hidden="true" tabindex="-1"></a>We might be tempted to infer that weighting wasn't relevant to the analysis. However, we'll see that such an interpretation would be a mistake.</span>
<span id="cb36-289"><a href="#cb36-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-290"><a href="#cb36-290" aria-hidden="true" tabindex="-1"></a>Next, we obtain model coefficients for the population. Note again there is no difference -- only narrower errors owing to the large sample size.</span>
<span id="cb36-291"><a href="#cb36-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-294"><a href="#cb36-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-295"><a href="#cb36-295" aria-hidden="true" tabindex="-1"></a><span class="co"># model coefficients population -- note that these coefficients are very similar. </span></span>
<span id="cb36-296"><a href="#cb36-296" aria-hidden="true" tabindex="-1"></a>model_population <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_population <span class="sc">~</span> a_population <span class="sc">*</span> z_population, </span>
<span id="cb36-297"><a href="#cb36-297" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> population_data)</span>
<span id="cb36-298"><a href="#cb36-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-299"><a href="#cb36-299" aria-hidden="true" tabindex="-1"></a>parameters<span class="sc">::</span><span class="fu">model_parameters</span>(model_population, <span class="at">ci_method =</span> <span class="st">'wald'</span>)</span>
<span id="cb36-300"><a href="#cb36-300" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-301"><a href="#cb36-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-302"><a href="#cb36-302" aria-hidden="true" tabindex="-1"></a>Again, there is no difference. That is, we find that all model coefficients are practically equivalent. The different distribution of effect modifiers does not result in different coefficient values for the treatment effect, the effect-modifier 'effect,' or the interaction of the effect modifier and treatment.</span>
<span id="cb36-303"><a href="#cb36-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-304"><a href="#cb36-304" aria-hidden="true" tabindex="-1"></a>Consider why this is the case: in a large sample where the causal effects are invariant -- as we have simulated them to be -- we will have good replication in the effect modifiers within the sample, so our statistical model can recover the *coefficients* for the population without challenge.</span>
<span id="cb36-305"><a href="#cb36-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-306"><a href="#cb36-306" aria-hidden="true" tabindex="-1"></a>However, in causal inference, we are interested in the marginal effect of the treatment within a population of interest or within strata of this population. That is, we seek an estimate for the counterfactual contrast in which everyone in a pre-specified population or stratum of a population was subject to one level of treatment compared with a counterfactual condition in which everyone in a population was subject to another level of the same treatment.</span>
<span id="cb36-307"><a href="#cb36-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-308"><a href="#cb36-308" aria-hidden="true" tabindex="-1"></a>**The marginal effect estimates will differ in at least one measure of effect when the analytic sample population has a different distribution of effect modifiers compared to the target population.**</span>
<span id="cb36-309"><a href="#cb36-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-310"><a href="#cb36-310" aria-hidden="true" tabindex="-1"></a>To see this, we use the <span class="in">`stdReg`</span> package to recover marginal effect estimates, comparing (1) the sample ATE, (2) the true oracle ATE for the population, and (3) the weighted sample ATE. We will use the outputs of the same models above. The only difference is that we will calculate marginal effects from these outputs. We will contrast a difference from an intervention in which everyone receives treatment = 0 with one in which everyone receives treatment = 1; however, this choice is arbitrary, and the general lessons apply irrespective of the estimand.</span>
<span id="cb36-311"><a href="#cb36-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-312"><a href="#cb36-312" aria-hidden="true" tabindex="-1"></a>First, consider this Average Treatment Effect for the analytic population:</span>
<span id="cb36-313"><a href="#cb36-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-316"><a href="#cb36-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-317"><a href="#cb36-317" aria-hidden="true" tabindex="-1"></a><span class="co"># What inference do we draw?  </span></span>
<span id="cb36-318"><a href="#cb36-318" aria-hidden="true" tabindex="-1"></a><span class="co"># we cannot say the models are unbiased for the marginal effect estimates. </span></span>
<span id="cb36-319"><a href="#cb36-319" aria-hidden="true" tabindex="-1"></a><span class="co"># regression standardisation </span></span>
<span id="cb36-320"><a href="#cb36-320" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stdReg) <span class="co"># to obtain marginal effects </span></span>
<span id="cb36-321"><a href="#cb36-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-322"><a href="#cb36-322" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain sample ate</span></span>
<span id="cb36-323"><a href="#cb36-323" aria-hidden="true" tabindex="-1"></a>fit_std_sample <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(model_sample, </span>
<span id="cb36-324"><a href="#cb36-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data, <span class="at">X =</span> <span class="st">'a_sample'</span>)</span>
<span id="cb36-325"><a href="#cb36-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-326"><a href="#cb36-326" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb36-327"><a href="#cb36-327" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_std_sample, <span class="at">contrast =</span> <span class="st">'difference'</span>, <span class="at">reference =</span> <span class="dv">0</span>)</span>
<span id="cb36-328"><a href="#cb36-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-329"><a href="#cb36-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-330"><a href="#cb36-330" aria-hidden="true" tabindex="-1"></a>The treatment effect is given as a 1.06 unit change in the outcome across the analytic population, with a confidence interval from 1.04 to 1.08.</span>
<span id="cb36-331"><a href="#cb36-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-332"><a href="#cb36-332" aria-hidden="true" tabindex="-1"></a>Next, we obtain the true (oracle) treatment effect for the target population under the same intervention:</span>
<span id="cb36-333"><a href="#cb36-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-336"><a href="#cb36-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-337"><a href="#cb36-337" aria-hidden="true" tabindex="-1"></a><span class="do">## note the population effect is different</span></span>
<span id="cb36-338"><a href="#cb36-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-339"><a href="#cb36-339" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain true ate</span></span>
<span id="cb36-340"><a href="#cb36-340" aria-hidden="true" tabindex="-1"></a>fit_std_population <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(model_population, </span>
<span id="cb36-341"><a href="#cb36-341" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> population_data, <span class="at">X =</span> <span class="st">'a_population'</span>)</span>
<span id="cb36-342"><a href="#cb36-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-343"><a href="#cb36-343" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb36-344"><a href="#cb36-344" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_std_population, <span class="at">contrast =</span> <span class="st">'difference'</span>, <span class="at">reference =</span> <span class="dv">0</span>)</span>
<span id="cb36-345"><a href="#cb36-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-346"><a href="#cb36-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-347"><a href="#cb36-347" aria-hidden="true" tabindex="-1"></a>Note that the true treatment effect is a 1.25-unit change in the population, with a confidence bound between 1.24 and 1.26. This is well outside the ATE that we obtain from the analytic population!</span>
<span id="cb36-348"><a href="#cb36-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-349"><a href="#cb36-349" aria-hidden="true" tabindex="-1"></a>Next, consider the ATE in the weighted regression, where the analytic sample was weighted to the target population's true distribution of effect modifiers:</span>
<span id="cb36-350"><a href="#cb36-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-353"><a href="#cb36-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-354"><a href="#cb36-354" aria-hidden="true" tabindex="-1"></a><span class="do">## next try weights adjusted ate where we correctly assign population weights to the sample</span></span>
<span id="cb36-355"><a href="#cb36-355" aria-hidden="true" tabindex="-1"></a>fit_std_weighted_sample_weights <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(model_weighted_sample, </span>
<span id="cb36-356"><a href="#cb36-356" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sample_data, <span class="at">X =</span> <span class="st">'a_sample'</span>)</span>
<span id="cb36-357"><a href="#cb36-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-358"><a href="#cb36-358" aria-hidden="true" tabindex="-1"></a><span class="co"># this gives us the right answer</span></span>
<span id="cb36-359"><a href="#cb36-359" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_std_weighted_sample_weights, <span class="at">contrast =</span> <span class="st">'difference'</span>, <span class="at">reference =</span> <span class="dv">0</span>)</span>
<span id="cb36-360"><a href="#cb36-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-361"><a href="#cb36-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-362"><a href="#cb36-362" aria-hidden="true" tabindex="-1"></a>We find that we obtain the population-level causal effect estimate with accurate coverage by weighting the sample to the target population. So with appropriate weights, our results generalise from the sample to the target population.</span>
<span id="cb36-363"><a href="#cb36-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-364"><a href="#cb36-364" aria-hidden="true" tabindex="-1"></a><span class="fu">## Lessons</span></span>
<span id="cb36-365"><a href="#cb36-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-366"><a href="#cb36-366" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Regression coefficients do not clarify the problem of sample/target population mismatch** — or selection bias as discussed in this manuscript.</span>
<span id="cb36-367"><a href="#cb36-367" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Investigators should not rely on regression coefficients alone** when evaluating the biases that arise from sample attrition. This advice applies to both methods that authors use to investigate threats of bias. To implement this advice, authors must first take it themselves.</span>
<span id="cb36-368"><a href="#cb36-368" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Observed data are generally insufficient for assessing threats**. Observed data do not clarify structural sources of bias, nor do they clarify effect-modification in the full counterfactual data condition where all receive the treatment and all do not receive the treatment (at the same level).</span>
<span id="cb36-369"><a href="#cb36-369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**To properly assess bias, one needs access to the counterfactual outcome** — what would have happened to the missing participants had they not been lost to follow-up or had they responded? The joint distributions over 'full data' are inherently unobservable <span class="co">[</span><span class="ot">@vanderlaan2011</span><span class="co">]</span>.</span>
<span id="cb36-370"><a href="#cb36-370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**In simple settings, like the one we just simulated, we can address the gap between the sample and target population using methods such as modelling the censoring (e.g., censoring weighting).** However, we never know what setting we are in or whether it is simple—such modelling must be handled carefully. There is a large and growing epidemiology literature on this topic (see, for example, @li2023non).</span>
<span id="cb36-371"><a href="#cb36-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-372"><a href="#cb36-372" aria-hidden="true" tabindex="-1"></a>--- </span>
<span id="cb36-373"><a href="#cb36-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-374"><a href="#cb36-374" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ambiguities from Cross-Sectional Data</span></span>
<span id="cb36-375"><a href="#cb36-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-376"><a href="#cb36-376" aria-hidden="true" tabindex="-1"></a><span class="fu">### Methodology</span></span>
<span id="cb36-377"><a href="#cb36-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-378"><a href="#cb36-378" aria-hidden="true" tabindex="-1"></a>**Data Generation**: we simulate a dataset for 1,000 individuals, where e.g. degree of religious belief ($A$) influences wealth ($L$), which in turn affects charitable donations ($Y$$). The simulation is based on predefined parameters that establish $L$ as a mediator between $A$ and $Y$.</span>
<span id="cb36-379"><a href="#cb36-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-380"><a href="#cb36-380" aria-hidden="true" tabindex="-1"></a>**Parameter Definitions**:</span>
<span id="cb36-381"><a href="#cb36-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-382"><a href="#cb36-382" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The probability of access to green space ($A$) is set at 0.5.</span>
<span id="cb36-383"><a href="#cb36-383" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The effect of $A$ on $L$ (exercise) is given by $\beta = 2$.</span>
<span id="cb36-384"><a href="#cb36-384" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The effect of $L$ on $Y$ (happiness) is given by $\delta = 1.5$.</span>
<span id="cb36-385"><a href="#cb36-385" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Standard deviations for $L$ and $Y$ are set at 1 and 1.5, respectively.</span>
<span id="cb36-386"><a href="#cb36-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-387"><a href="#cb36-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-388"><a href="#cb36-388" aria-hidden="true" tabindex="-1"></a>**Model 1** (Correct Assumption): fits a linear regression model assuming $L$ as a mediator, including both $A$ and $L$ as regressors on $Y$. This model aligns with the data-generating process, and, by the rules of d-separation, induces mediator bias for the $A\to Y$ path.</span>
<span id="cb36-389"><a href="#cb36-389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-390"><a href="#cb36-390" aria-hidden="true" tabindex="-1"></a>**Model 2** (Incorrect Assumption): fits a linear regression model including only $A$ as a regressor on $Y$, omitting the mediator $L$. This model assesses the direct effect of A on Y without accounting for mediation.</span>
<span id="cb36-391"><a href="#cb36-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-392"><a href="#cb36-392" aria-hidden="true" tabindex="-1"></a>**Analysis**: We compares the estimated effects of $A$ on $Y$ under each model specification.</span>
<span id="cb36-393"><a href="#cb36-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-394"><a href="#cb36-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-395"><a href="#cb36-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-398"><a href="#cb36-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-399"><a href="#cb36-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: simulation_cross_sectional</span></span>
<span id="cb36-400"><a href="#cb36-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Code for a simulation of a data generating process in which the effect of wealth (L) fully mediates the effect of reliigious belief (A) on donations (Y)."</span></span>
<span id="cb36-401"><a href="#cb36-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 80%</span></span>
<span id="cb36-402"><a href="#cb36-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb36-403"><a href="#cb36-403" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb36-404"><a href="#cb36-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-405"><a href="#cb36-405" aria-hidden="true" tabindex="-1"></a><span class="co"># load libraries</span></span>
<span id="cb36-406"><a href="#cb36-406" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span><span class="fu">require</span>(kableExtra)<span class="er">)</span>{<span class="fu">install.packages</span>(<span class="st">"kableExtra"</span>)} <span class="co"># tables</span></span>
<span id="cb36-407"><a href="#cb36-407" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(gtsummary)){<span class="fu">install.packages</span>(<span class="st">"gtsummary"</span>)} <span class="co"># tables</span></span>
<span id="cb36-408"><a href="#cb36-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-409"><a href="#cb36-409" aria-hidden="true" tabindex="-1"></a><span class="co"># simulation seed</span></span>
<span id="cb36-410"><a href="#cb36-410" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co">#  reproducibility</span></span>
<span id="cb36-411"><a href="#cb36-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-412"><a href="#cb36-412" aria-hidden="true" tabindex="-1"></a><span class="co"># define the parameters </span></span>
<span id="cb36-413"><a href="#cb36-413" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1000</span> <span class="co"># Number of observations</span></span>
<span id="cb36-414"><a href="#cb36-414" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fl">0.5</span>  <span class="co"># Probability of A = 1 (exposure)</span></span>
<span id="cb36-415"><a href="#cb36-415" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="dv">0</span> <span class="co"># Intercept for L (mediator)</span></span>
<span id="cb36-416"><a href="#cb36-416" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> <span class="dv">2</span>  <span class="co"># Effect of A on L </span></span>
<span id="cb36-417"><a href="#cb36-417" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">=</span> <span class="dv">1</span> <span class="co"># Intercept for Y </span></span>
<span id="cb36-418"><a href="#cb36-418" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">=</span> <span class="fl">1.5</span> <span class="co"># Effect of L on Y</span></span>
<span id="cb36-419"><a href="#cb36-419" aria-hidden="true" tabindex="-1"></a>sigma_L <span class="ot">=</span> <span class="dv">1</span> <span class="co"># Standard deviation of L</span></span>
<span id="cb36-420"><a href="#cb36-420" aria-hidden="true" tabindex="-1"></a>sigma_Y <span class="ot">=</span> <span class="fl">1.5</span> <span class="co"># Standard deviation of Y</span></span>
<span id="cb36-421"><a href="#cb36-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-422"><a href="#cb36-422" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate the data: fully mediated effect by L</span></span>
<span id="cb36-423"><a href="#cb36-423" aria-hidden="true" tabindex="-1"></a>A <span class="ot">=</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, p) <span class="co"># binary exposure variable</span></span>
<span id="cb36-424"><a href="#cb36-424" aria-hidden="true" tabindex="-1"></a>L <span class="ot">=</span> alpha <span class="sc">+</span> beta<span class="sc">*</span>A <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, sigma_L) <span class="co"># mediator L affect by A</span></span>
<span id="cb36-425"><a href="#cb36-425" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> gamma <span class="sc">+</span> delta<span class="sc">*</span>L <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, sigma_Y) <span class="co"># Y affected only by L,</span></span>
<span id="cb36-426"><a href="#cb36-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-427"><a href="#cb36-427" aria-hidden="true" tabindex="-1"></a><span class="co"># make the data frame</span></span>
<span id="cb36-428"><a href="#cb36-428" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">A =</span> A, <span class="at">L =</span> L, <span class="at">Y =</span> Y)</span>
<span id="cb36-429"><a href="#cb36-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-430"><a href="#cb36-430" aria-hidden="true" tabindex="-1"></a><span class="co"># fit regression in which we control for L, a mediator</span></span>
<span id="cb36-431"><a href="#cb36-431" aria-hidden="true" tabindex="-1"></a><span class="co"># (cross-sectional data is consistent with this model)</span></span>
<span id="cb36-432"><a href="#cb36-432" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> <span class="fu">lm</span>( Y <span class="sc">~</span> A <span class="sc">+</span> L, <span class="at">data =</span> data)</span>
<span id="cb36-433"><a href="#cb36-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-434"><a href="#cb36-434" aria-hidden="true" tabindex="-1"></a><span class="co"># fit regression in which L is assumed to be a mediator, not a confounder.</span></span>
<span id="cb36-435"><a href="#cb36-435" aria-hidden="true" tabindex="-1"></a><span class="co"># (cross-sectional data is also consistent with this model)</span></span>
<span id="cb36-436"><a href="#cb36-436" aria-hidden="true" tabindex="-1"></a>fit_2 <span class="ot">&lt;-</span> <span class="fu">lm</span>( Y <span class="sc">~</span> A, <span class="at">data =</span> data)</span>
<span id="cb36-437"><a href="#cb36-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-438"><a href="#cb36-438" aria-hidden="true" tabindex="-1"></a><span class="co"># create gtsummary tables for each regression model</span></span>
<span id="cb36-439"><a href="#cb36-439" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> gtsummary<span class="sc">::</span><span class="fu">tbl_regression</span>(fit_1)</span>
<span id="cb36-440"><a href="#cb36-440" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">&lt;-</span> gtsummary<span class="sc">::</span><span class="fu">tbl_regression</span>(fit_2)</span>
<span id="cb36-441"><a href="#cb36-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-442"><a href="#cb36-442" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the tables for comparison</span></span>
<span id="cb36-443"><a href="#cb36-443" aria-hidden="true" tabindex="-1"></a>table_comparison <span class="ot">&lt;-</span> gtsummary<span class="sc">::</span><span class="fu">tbl_merge</span>(</span>
<span id="cb36-444"><a href="#cb36-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(table1, table2),</span>
<span id="cb36-445"><a href="#cb36-445" aria-hidden="true" tabindex="-1"></a>  <span class="at">tab_spanner =</span> <span class="fu">c</span>(<span class="st">"Model: Exercise assumed confounder"</span>, </span>
<span id="cb36-446"><a href="#cb36-446" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Model: Exercise assumed to be a mediator"</span>)</span>
<span id="cb36-447"><a href="#cb36-447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-448"><a href="#cb36-448" aria-hidden="true" tabindex="-1"></a><span class="co"># make html table (for publication)</span></span>
<span id="cb36-449"><a href="#cb36-449" aria-hidden="true" tabindex="-1"></a>markdown_table_0 <span class="ot">&lt;-</span> <span class="fu">as_kable_extra</span>(table_comparison, </span>
<span id="cb36-450"><a href="#cb36-450" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">format =</span> <span class="st">"html"</span>)</span>
<span id="cb36-451"><a href="#cb36-451" aria-hidden="true" tabindex="-1"></a><span class="co"># print table (note, you might prefer "markdown" or another format)                                </span></span>
<span id="cb36-452"><a href="#cb36-452" aria-hidden="true" tabindex="-1"></a>markdown_table_0</span>
<span id="cb36-453"><a href="#cb36-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-454"><a href="#cb36-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-455"><a href="#cb36-455" aria-hidden="true" tabindex="-1"></a>The following code is designed to estimate the Average Treatment Effect (ATE) using the <span class="in">`clarify`</span> package in R, which is referenced here as <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>. The procedure involves two steps: simulating coefficient distributions for regression models and then calculating the ATE based on these simulations. This process is applied to two distinct models to demonstrate the effects of including versus excluding a mediator variable in the analysis.</span>
<span id="cb36-456"><a href="#cb36-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-457"><a href="#cb36-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-458"><a href="#cb36-458" aria-hidden="true" tabindex="-1"></a><span class="fu">### Steps to Estimate the ATE</span></span>
<span id="cb36-459"><a href="#cb36-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-460"><a href="#cb36-460" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Load the `clarify` Package**: this package provides functions to simulate regression coefficients and compute average marginal effects (AME), robustly facilitating the estimation of ATE.</span>
<span id="cb36-461"><a href="#cb36-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-462"><a href="#cb36-462" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Set seed**: <span class="in">`set.seed(123)`</span> ensures that the results of the simulations are reproducible, allowing for consistent outcomes across different code runs.</span>
<span id="cb36-463"><a href="#cb36-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-464"><a href="#cb36-464" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Simulate the data distribution**:</span>
<span id="cb36-465"><a href="#cb36-465" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb36-466"><a href="#cb36-466" aria-hidden="true" tabindex="-1"></a>   <span class="in">`sim_coefs_fit_1`</span> and <span class="in">`sim_coefs_fit_2`</span> are generated using the <span class="in">`sim`</span> function from the <span class="in">`clarify`</span> package, applied to two fitted models (<span class="in">`fit_1`</span> and <span class="in">`fit_2`</span>). These functions simulate the distribution of coefficients based on the specified models, capturing the uncertainty around the estimated parameters.</span>
<span id="cb36-467"><a href="#cb36-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-468"><a href="#cb36-468" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Calculate ATE**:</span>
<span id="cb36-469"><a href="#cb36-469" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-470"><a href="#cb36-470" aria-hidden="true" tabindex="-1"></a>  For both models, the <span class="in">`sim_ame`</span> function calculates the ATE as the marginal risk difference (RD) when the treatment variable (<span class="in">`A`</span>) is present (<span class="in">`A == 1`</span>). This function uses the simulated coefficients to estimate the treatment effect across the simulated distributions, providing a comprehensive view of the ATE under each model.</span>
<span id="cb36-471"><a href="#cb36-471" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-472"><a href="#cb36-472" aria-hidden="true" tabindex="-1"></a>  To streamline the output, the function is set to verbose mode off (<span class="in">`verbose = FALSE`</span>).</span>
<span id="cb36-473"><a href="#cb36-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-474"><a href="#cb36-474" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Results**:</span>
<span id="cb36-475"><a href="#cb36-475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-476"><a href="#cb36-476" aria-hidden="true" tabindex="-1"></a>  Summaries of these estimates (<span class="in">`summary_sim_est_fit_1`</span> and <span class="in">`summary_sim_est_fit_2`</span>) are obtained, providing detailed statistics including the estimated ATE and its 95% confidence intervals (CI).</span>
<span id="cb36-477"><a href="#cb36-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-478"><a href="#cb36-478" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Presentation: report ATE and CIs**:</span>
<span id="cb36-479"><a href="#cb36-479" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb36-480"><a href="#cb36-480" aria-hidden="true" tabindex="-1"></a>Using the <span class="in">`glue`</span> package, the ATE and its 95% CIs for both models are formatted into a string for easy reporting. This step transforms the statistical output into a more interpretable form, highlighting the estimated treatment effect and its precision.</span>
<span id="cb36-481"><a href="#cb36-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-482"><a href="#cb36-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-485"><a href="#cb36-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-486"><a href="#cb36-486" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ate-sim-crosstwo</span></span>
<span id="cb36-487"><a href="#cb36-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Code for calculating the average treatment effect as contrasts between simulated outcomes for the entire population."</span></span>
<span id="cb36-488"><a href="#cb36-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb36-489"><a href="#cb36-489" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb36-490"><a href="#cb36-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-491"><a href="#cb36-491" aria-hidden="true" tabindex="-1"></a><span class="co"># use `clarify` package to obtain ATE</span></span>
<span id="cb36-492"><a href="#cb36-492" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(clarify)){<span class="fu">install.packages</span>(<span class="st">"clarify"</span>)} <span class="co"># clarify package</span></span>
<span id="cb36-493"><a href="#cb36-493" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate fit 1 ATE</span></span>
<span id="cb36-494"><a href="#cb36-494" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb36-495"><a href="#cb36-495" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_1 <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_1)</span>
<span id="cb36-496"><a href="#cb36-496" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_2 <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_2)</span>
<span id="cb36-497"><a href="#cb36-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-498"><a href="#cb36-498" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 1 (L is a confounder)</span></span>
<span id="cb36-499"><a href="#cb36-499" aria-hidden="true" tabindex="-1"></a>sim_est_fit_1 <span class="ot">&lt;-</span></span>
<span id="cb36-500"><a href="#cb36-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb36-501"><a href="#cb36-501" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_1,</span>
<span id="cb36-502"><a href="#cb36-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A"</span>,</span>
<span id="cb36-503"><a href="#cb36-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb36-504"><a href="#cb36-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb36-505"><a href="#cb36-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb36-506"><a href="#cb36-506" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-507"><a href="#cb36-507" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 2 (L is a mediator)</span></span>
<span id="cb36-508"><a href="#cb36-508" aria-hidden="true" tabindex="-1"></a>sim_est_fit_2 <span class="ot">&lt;-</span></span>
<span id="cb36-509"><a href="#cb36-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb36-510"><a href="#cb36-510" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_2,</span>
<span id="cb36-511"><a href="#cb36-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A"</span>,</span>
<span id="cb36-512"><a href="#cb36-512" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb36-513"><a href="#cb36-513" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb36-514"><a href="#cb36-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb36-515"><a href="#cb36-515" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-516"><a href="#cb36-516" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain summaries</span></span>
<span id="cb36-517"><a href="#cb36-517" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(sim_est_fit_1, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb36-518"><a href="#cb36-518" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(sim_est_fit_2, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb36-519"><a href="#cb36-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-520"><a href="#cb36-520" aria-hidden="true" tabindex="-1"></a><span class="co"># reporting </span></span>
<span id="cb36-521"><a href="#cb36-521" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 1, with 95% CI</span></span>
<span id="cb36-522"><a href="#cb36-522" aria-hidden="true" tabindex="-1"></a>ATE_fit_1 <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb36-523"><a href="#cb36-523" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE =</span></span>
<span id="cb36-524"><a href="#cb36-524" aria-hidden="true" tabindex="-1"></a><span class="st">                        {round(summary_sim_est_fit_1[3, 1], 2)},</span></span>
<span id="cb36-525"><a href="#cb36-525" aria-hidden="true" tabindex="-1"></a><span class="st">                        CI = [{round(summary_sim_est_fit_1[3, 2], 2)},</span></span>
<span id="cb36-526"><a href="#cb36-526" aria-hidden="true" tabindex="-1"></a><span class="st">                        {round(summary_sim_est_fit_1[3, 3], 2)}]"</span></span>
<span id="cb36-527"><a href="#cb36-527" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-528"><a href="#cb36-528" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 2, with 95% CI</span></span>
<span id="cb36-529"><a href="#cb36-529" aria-hidden="true" tabindex="-1"></a>ATE_fit_2 <span class="ot">&lt;-</span></span>
<span id="cb36-530"><a href="#cb36-530" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb36-531"><a href="#cb36-531" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE = {round(summary_sim_est_fit_2[3, 1], 2)},</span></span>
<span id="cb36-532"><a href="#cb36-532" aria-hidden="true" tabindex="-1"></a><span class="st">                        CI = [{round(summary_sim_est_fit_2[3, 2], 2)},</span></span>
<span id="cb36-533"><a href="#cb36-533" aria-hidden="true" tabindex="-1"></a><span class="st">                        {round(summary_sim_est_fit_2[3, 3], 2)}]"</span></span>
<span id="cb36-534"><a href="#cb36-534" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-535"><a href="#cb36-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-536"><a href="#cb36-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-537"><a href="#cb36-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-538"><a href="#cb36-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-539"><a href="#cb36-539" aria-hidden="true" tabindex="-1"></a><span class="fu">### Upshot of the Simulation and Analysis</span></span>
<span id="cb36-540"><a href="#cb36-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-541"><a href="#cb36-541" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model 1 (L as a Confounder)**: this analysis assumes that <span class="in">`L`</span> is a confounder in the relationship between the treatment (<span class="in">`A`</span>) and the outcome (<span class="in">`Y`</span>), and thus, it includes <span class="in">`L`</span> in the model. The ATE estimated here reflects the effect of <span class="in">`A`</span> while controlling for <span class="in">`L`</span>.</span>
<span id="cb36-542"><a href="#cb36-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-543"><a href="#cb36-543" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model 2 (L as a Mediator)**: in contrast, this analysis considers <span class="in">`L`</span> to be a mediator, and the model either includes <span class="in">`L`</span> explicitly in its estimation process or excludes it to examine the direct effect of <span class="in">`A`</span> on <span class="in">`Y`</span>. The approach to mediation analysis here is crucial as it influences the interpretation of the ATE.</span>
<span id="cb36-544"><a href="#cb36-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-545"><a href="#cb36-545" aria-hidden="true" tabindex="-1"></a>By comparing the ATEs from both models, researchers can understand the effect of mediation (or the lack thereof) on the estimated treatment effect. This comparison sheds light on how assumptions about variable roles (confounder vs. mediator) can significantly alter causal inferences drawn from cross-sectional data.</span>
<span id="cb36-546"><a href="#cb36-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-547"><a href="#cb36-547" aria-hidden="true" tabindex="-1"></a>**Wherever it is uncertain whether a variable is a confounder or a mediator, we suggest creating two causal diagrams and reporting both analyses.**</span>
<span id="cb36-548"><a href="#cb36-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-549"><a href="#cb36-549" aria-hidden="true" tabindex="-1"></a>{{&lt; pagebreak &gt;}}</span>
<span id="cb36-550"><a href="#cb36-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-551"><a href="#cb36-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-552"><a href="#cb36-552" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix D: Simulation of Different Confounding Control Strategies {#appendix-d}</span></span>
<span id="cb36-553"><a href="#cb36-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-554"><a href="#cb36-554" aria-hidden="true" tabindex="-1"></a>This appendix outlines the methodology and results of a data simulation designed to compare different strategies for controlling confounding in the context of environmental psychology research. Specifically, the simulation examines the effect of access to open green spaces (treatment, $A_1$) on happiness (outcome, $Y_2$) while addressing the challenge of unmeasured confounding. The simulation incorporates baseline measures of exposure and outcome ($A_0$, $Y_0$), baseline confounders ($L_0$), and an unmeasured confounder ($U$) to evaluate the effectiveness of different analytical approaches.</span>
<span id="cb36-555"><a href="#cb36-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-556"><a href="#cb36-556" aria-hidden="true" tabindex="-1"></a><span class="fu">###  Methodology</span></span>
<span id="cb36-557"><a href="#cb36-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-558"><a href="#cb36-558" aria-hidden="true" tabindex="-1"></a>1.**Load Libraries `kableExtra`, `gtsummary`, and `grf`.**</span>
<span id="cb36-559"><a href="#cb36-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-560"><a href="#cb36-560" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Target**: we simulate data for 10,000 individuals, including baseline exposure to green spaces ($A_0$), baseline happiness ($Y_0$), baseline confounders ($L_0$), and an unmeasured confounder ($U$). The simulation uses a logistic model for treatment assignment and a linear model for the continuous outcome, incorporating interactions to assess how baseline characteristics modify the treatment effect.</span>
<span id="cb36-561"><a href="#cb36-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-562"><a href="#cb36-562" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Set seed and simulate the data distribution**:</span>
<span id="cb36-563"><a href="#cb36-563" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-564"><a href="#cb36-564" aria-hidden="true" tabindex="-1"></a>  Treatment assignment coefficients: $\beta_{A0} = 0.25$, $\beta_{Y0} = 0.3$, $\beta_{L0} = 0.2$, and $\beta_{U} = 0.1$.</span>
<span id="cb36-565"><a href="#cb36-565" aria-hidden="true" tabindex="-1"></a>  Outcome model coefficients: $\delta_{A1} = 0.3$, $\delta_{Y0} = 0.9$, $\delta_{A0} = 0.1$, $\delta_{L0} = 0.3$, with an interaction effect ($\theta_{A0Y0L0} = 0.5$) indicating the combined influence of baseline exposure, outcome, and confounders on the follow-up outcome.</span>
<span id="cb36-566"><a href="#cb36-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-567"><a href="#cb36-567" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Model comparison**:</span>
<span id="cb36-568"><a href="#cb36-568" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>**No control model**: estimates the effect of $A_1$ on $Y_2$ without controlling for any confounders.</span>
<span id="cb36-569"><a href="#cb36-569" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>**Standard covariate control model**: controls for baseline confounders ($L_0$) alongside treatment ($A_1$).</span>
<span id="cb36-570"><a href="#cb36-570" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>**Baseline exposure and outcome model**: extends the standard model by including baseline treatment and outcome ($A_0$, $Y_0$) and their interaction with $L_0$.</span>
<span id="cb36-571"><a href="#cb36-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-572"><a href="#cb36-572" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Results**: each model's effectiveness in estimating the true treatment effect is assessed by comparing regression outputs. The simulation evaluates how well each model addresses the bias introduced by unmeasured confounding and the role of baseline characteristics in modifying treatment effects.</span>
<span id="cb36-573"><a href="#cb36-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-574"><a href="#cb36-574" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Presentation**: the results are synthesised in a comparative table, formatted using the <span class="in">`kableExtra`</span> {@zhu2021KableExtra] and <span class="in">`gtsummary`</span> packages <span class="co">[</span><span class="ot">@gtsummary2021</span><span class="co">]</span>, highlighting the estimated treatment effects and their statistical significance across models.</span>
<span id="cb36-575"><a href="#cb36-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-576"><a href="#cb36-576" aria-hidden="true" tabindex="-1"></a>Overall, we use the simulation to illustrate the importance of incorporating baseline characteristics and their interactions to mitigate the influence of unmeasured confounding. </span>
<span id="cb36-577"><a href="#cb36-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-578"><a href="#cb36-578" aria-hidden="true" tabindex="-1"></a>Here is the simulation/model code:</span>
<span id="cb36-579"><a href="#cb36-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-582"><a href="#cb36-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-583"><a href="#cb36-583" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-codelg-appendix</span></span>
<span id="cb36-584"><a href="#cb36-584" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb36-585"><a href="#cb36-585" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb36-586"><a href="#cb36-586" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb36-587"><a href="#cb36-587" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(kableExtra)){<span class="fu">install.packages</span>(<span class="st">"kableExtra"</span>)} <span class="co"># causal forest</span></span>
<span id="cb36-588"><a href="#cb36-588" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(gtsummary)){<span class="fu">install.packages</span>(<span class="st">"gtsummary"</span>)} <span class="co"># causal forest</span></span>
<span id="cb36-589"><a href="#cb36-589" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(grf)){<span class="fu">install.packages</span>(<span class="st">"grf"</span>)} <span class="co"># causal forest</span></span>
<span id="cb36-590"><a href="#cb36-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-591"><a href="#cb36-591" aria-hidden="true" tabindex="-1"></a><span class="co"># r_texmf()eproducibility</span></span>
<span id="cb36-592"><a href="#cb36-592" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb36-593"><a href="#cb36-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-594"><a href="#cb36-594" aria-hidden="true" tabindex="-1"></a><span class="co"># set number of observations</span></span>
<span id="cb36-595"><a href="#cb36-595" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10000</span> </span>
<span id="cb36-596"><a href="#cb36-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-597"><a href="#cb36-597" aria-hidden="true" tabindex="-1"></a><span class="co"># baseline covariates</span></span>
<span id="cb36-598"><a href="#cb36-598" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n) <span class="co"># Unmeasured confounder</span></span>
<span id="cb36-599"><a href="#cb36-599" aria-hidden="true" tabindex="-1"></a>A_0 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(U)) <span class="co"># Baseline exposure</span></span>
<span id="cb36-600"><a href="#cb36-600" aria-hidden="true" tabindex="-1"></a>Y_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> U, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Baseline outcome</span></span>
<span id="cb36-601"><a href="#cb36-601" aria-hidden="true" tabindex="-1"></a>L_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> U, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Baseline confounders</span></span>
<span id="cb36-602"><a href="#cb36-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-603"><a href="#cb36-603" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients for treatment assignment</span></span>
<span id="cb36-604"><a href="#cb36-604" aria-hidden="true" tabindex="-1"></a>beta_A0 <span class="ot">=</span> <span class="fl">0.25</span></span>
<span id="cb36-605"><a href="#cb36-605" aria-hidden="true" tabindex="-1"></a>beta_Y0 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb36-606"><a href="#cb36-606" aria-hidden="true" tabindex="-1"></a>beta_L0 <span class="ot">=</span> <span class="fl">0.2</span></span>
<span id="cb36-607"><a href="#cb36-607" aria-hidden="true" tabindex="-1"></a>beta_U <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb36-608"><a href="#cb36-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-609"><a href="#cb36-609" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate treatment assignment</span></span>
<span id="cb36-610"><a href="#cb36-610" aria-hidden="true" tabindex="-1"></a>A_1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">+</span> </span>
<span id="cb36-611"><a href="#cb36-611" aria-hidden="true" tabindex="-1"></a>                                    beta_A0 <span class="sc">*</span> A_0 <span class="sc">+</span></span>
<span id="cb36-612"><a href="#cb36-612" aria-hidden="true" tabindex="-1"></a>                                    beta_Y0 <span class="sc">*</span> Y_0 <span class="sc">+</span> </span>
<span id="cb36-613"><a href="#cb36-613" aria-hidden="true" tabindex="-1"></a>                                    beta_L0 <span class="sc">*</span> L_0 <span class="sc">+</span> </span>
<span id="cb36-614"><a href="#cb36-614" aria-hidden="true" tabindex="-1"></a>                                    beta_U <span class="sc">*</span> U))</span>
<span id="cb36-615"><a href="#cb36-615" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients for continuous outcome</span></span>
<span id="cb36-616"><a href="#cb36-616" aria-hidden="true" tabindex="-1"></a>delta_A1 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb36-617"><a href="#cb36-617" aria-hidden="true" tabindex="-1"></a>delta_Y0 <span class="ot">=</span> <span class="fl">0.9</span></span>
<span id="cb36-618"><a href="#cb36-618" aria-hidden="true" tabindex="-1"></a>delta_A0 <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb36-619"><a href="#cb36-619" aria-hidden="true" tabindex="-1"></a>delta_L0 <span class="ot">=</span> <span class="fl">0.3</span></span>
<span id="cb36-620"><a href="#cb36-620" aria-hidden="true" tabindex="-1"></a>theta_A0Y0L0 <span class="ot">=</span> <span class="fl">0.5</span> <span class="co"># Interaction effect between A_1 and L_0</span></span>
<span id="cb36-621"><a href="#cb36-621" aria-hidden="true" tabindex="-1"></a>delta_U <span class="ot">=</span> <span class="fl">0.05</span></span>
<span id="cb36-622"><a href="#cb36-622" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate continuous outcome including interaction</span></span>
<span id="cb36-623"><a href="#cb36-623" aria-hidden="true" tabindex="-1"></a>Y_2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,</span>
<span id="cb36-624"><a href="#cb36-624" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean =</span> <span class="dv">0</span> <span class="sc">+</span></span>
<span id="cb36-625"><a href="#cb36-625" aria-hidden="true" tabindex="-1"></a>               delta_A1 <span class="sc">*</span> A_1 <span class="sc">+</span> </span>
<span id="cb36-626"><a href="#cb36-626" aria-hidden="true" tabindex="-1"></a>               delta_Y0 <span class="sc">*</span> Y_0 <span class="sc">+</span> </span>
<span id="cb36-627"><a href="#cb36-627" aria-hidden="true" tabindex="-1"></a>               delta_A0 <span class="sc">*</span> A_0 <span class="sc">+</span> </span>
<span id="cb36-628"><a href="#cb36-628" aria-hidden="true" tabindex="-1"></a>               delta_L0 <span class="sc">*</span> L_0 <span class="sc">+</span> </span>
<span id="cb36-629"><a href="#cb36-629" aria-hidden="true" tabindex="-1"></a>               theta_A0Y0L0 <span class="sc">*</span> Y_0 <span class="sc">*</span> </span>
<span id="cb36-630"><a href="#cb36-630" aria-hidden="true" tabindex="-1"></a>               A_0 <span class="sc">*</span> L_0 <span class="sc">+</span> </span>
<span id="cb36-631"><a href="#cb36-631" aria-hidden="true" tabindex="-1"></a>               delta_U <span class="sc">*</span> U,</span>
<span id="cb36-632"><a href="#cb36-632" aria-hidden="true" tabindex="-1"></a>             <span class="at">sd =</span> .<span class="dv">5</span>)</span>
<span id="cb36-633"><a href="#cb36-633" aria-hidden="true" tabindex="-1"></a><span class="co"># assemble data frame</span></span>
<span id="cb36-634"><a href="#cb36-634" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Y_2, A_0, A_1, L_0, Y_0, U)</span>
<span id="cb36-635"><a href="#cb36-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-636"><a href="#cb36-636" aria-hidden="true" tabindex="-1"></a><span class="co"># model: no control</span></span>
<span id="cb36-637"><a href="#cb36-637" aria-hidden="true" tabindex="-1"></a>fit_no_control <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y_2 <span class="sc">~</span> A_1, <span class="at">data =</span> data)</span>
<span id="cb36-638"><a href="#cb36-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-639"><a href="#cb36-639" aria-hidden="true" tabindex="-1"></a><span class="co"># model: standard covariate control</span></span>
<span id="cb36-640"><a href="#cb36-640" aria-hidden="true" tabindex="-1"></a>fit_standard <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y_2 <span class="sc">~</span> A_1 <span class="sc">+</span> L_0, <span class="at">data =</span> data)</span>
<span id="cb36-641"><a href="#cb36-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-642"><a href="#cb36-642" aria-hidden="true" tabindex="-1"></a><span class="co"># model: interaction with baseline confounders, and baseline outcome and exposure</span></span>
<span id="cb36-643"><a href="#cb36-643" aria-hidden="true" tabindex="-1"></a>fit_interaction  <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y_2 <span class="sc">~</span> A_1 <span class="sc">*</span> (L_0 <span class="sc">+</span> A_0 <span class="sc">+</span> Y_0), <span class="at">data =</span> data)</span>
<span id="cb36-644"><a href="#cb36-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-645"><a href="#cb36-645" aria-hidden="true" tabindex="-1"></a><span class="co"># create gtsummary tables for each regression model</span></span>
<span id="cb36-646"><a href="#cb36-646" aria-hidden="true" tabindex="-1"></a>tbl_fit_no_control<span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(fit_no_control)  </span>
<span id="cb36-647"><a href="#cb36-647" aria-hidden="true" tabindex="-1"></a>tbl_fit_standard <span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(fit_standard)</span>
<span id="cb36-648"><a href="#cb36-648" aria-hidden="true" tabindex="-1"></a>tbl_fit_interaction <span class="ot">&lt;-</span> <span class="fu">tbl_regression</span>(fit_interaction)</span>
<span id="cb36-649"><a href="#cb36-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-650"><a href="#cb36-650" aria-hidden="true" tabindex="-1"></a><span class="co"># get only the treatment variable</span></span>
<span id="cb36-651"><a href="#cb36-651" aria-hidden="true" tabindex="-1"></a>tbl_list_modified <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">list</span>(</span>
<span id="cb36-652"><a href="#cb36-652" aria-hidden="true" tabindex="-1"></a>  tbl_fit_no_control,</span>
<span id="cb36-653"><a href="#cb36-653" aria-hidden="true" tabindex="-1"></a>  tbl_fit_standard,</span>
<span id="cb36-654"><a href="#cb36-654" aria-hidden="true" tabindex="-1"></a>  tbl_fit_interaction),</span>
<span id="cb36-655"><a href="#cb36-655" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(tbl) {</span>
<span id="cb36-656"><a href="#cb36-656" aria-hidden="true" tabindex="-1"></a>  tbl <span class="sc">%&gt;%</span></span>
<span id="cb36-657"><a href="#cb36-657" aria-hidden="true" tabindex="-1"></a>    <span class="fu">modify_table_body</span>(<span class="sc">~</span> .x <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">"A_1"</span>))</span>
<span id="cb36-658"><a href="#cb36-658" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-659"><a href="#cb36-659" aria-hidden="true" tabindex="-1"></a><span class="co"># merge tables</span></span>
<span id="cb36-660"><a href="#cb36-660" aria-hidden="true" tabindex="-1"></a>table_comparison <span class="ot">&lt;-</span> <span class="fu">tbl_merge</span>(</span>
<span id="cb36-661"><a href="#cb36-661" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbls =</span> tbl_list_modified,</span>
<span id="cb36-662"><a href="#cb36-662" aria-hidden="true" tabindex="-1"></a>  <span class="at">tab_spanner =</span> <span class="fu">c</span>(</span>
<span id="cb36-663"><a href="#cb36-663" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Control"</span>,</span>
<span id="cb36-664"><a href="#cb36-664" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Standard"</span>,</span>
<span id="cb36-665"><a href="#cb36-665" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Interaction"</span>)</span>
<span id="cb36-666"><a href="#cb36-666" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb36-667"><a href="#cb36-667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">modify_table_styling</span>(</span>
<span id="cb36-668"><a href="#cb36-668" aria-hidden="true" tabindex="-1"></a>    <span class="at">column =</span> <span class="fu">c</span>(p.value_1, p.value_2, p.value_3),</span>
<span id="cb36-669"><a href="#cb36-669" aria-hidden="true" tabindex="-1"></a>    <span class="at">hide =</span> <span class="cn">TRUE</span></span>
<span id="cb36-670"><a href="#cb36-670" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-671"><a href="#cb36-671" aria-hidden="true" tabindex="-1"></a><span class="co"># markdown table for publication</span></span>
<span id="cb36-672"><a href="#cb36-672" aria-hidden="true" tabindex="-1"></a>markdown_table <span class="ot">&lt;-</span></span>
<span id="cb36-673"><a href="#cb36-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_kable_extra</span>(table_comparison, <span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb36-674"><a href="#cb36-674" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(markdown_table)</span>
<span id="cb36-675"><a href="#cb36-675" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-676"><a href="#cb36-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-677"><a href="#cb36-677" aria-hidden="true" tabindex="-1"></a>Next, in the following code, we calculate the Average Treatment Effect (ATE) using simulation-based approaches for two distinct models: one with standard covariate control and another incorporating interaction. This approach leverages the <span class="in">`clarify`</span> package in R, which facilitates the simulation and interpretation of estimated coefficients from linear models to derive ATEs under different modelling assumptions <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb36-678"><a href="#cb36-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-679"><a href="#cb36-679" aria-hidden="true" tabindex="-1"></a>First, we use the <span class="in">`sim`</span> function from the <span class="in">`clarify`</span> package to generate simulated coefficient distributions for the standard model (<span class="in">`fit_standard`</span>) and the interaction model (<span class="in">`fit_interaction`</span>). This step is crucial for capturing the uncertainty in our estimates arising from sampling variability.</span>
<span id="cb36-680"><a href="#cb36-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-681"><a href="#cb36-681" aria-hidden="true" tabindex="-1"></a>Next, we employ each model's <span class="in">`sim_ame`</span> function to compute the average marginal effects (AME), focusing on the treatment variable (<span class="in">`A_1`</span>). The calculation is done under the assumption that all individuals are treated (i.e., <span class="in">`A_1 == 1`</span>), and we specify the contrast type as "RD" (Risk Difference) to directly obtain the ATE (Average Treatment Effect). The <span class="in">`sim_ame`</span> function simulates the treatment effect across the distribution of simulated coefficients, providing a robust estimate of the ATE and its variability.</span>
<span id="cb36-682"><a href="#cb36-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-683"><a href="#cb36-683" aria-hidden="true" tabindex="-1"></a>The summaries of these simulations (<span class="in">`summary_sim_est_fit_std`</span> and <span class="in">`summary_sim_est_fit_int`</span>) are then extracted to provide concise estimates of the ATE along with 95% confidence intervals (CIs) for both the standard and interaction models. This step is essential for understanding the magnitude and precision of the treatment effects estimated by the models.</span>
<span id="cb36-684"><a href="#cb36-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-685"><a href="#cb36-685" aria-hidden="true" tabindex="-1"></a>Finally, we use the <span class="in">`glue`</span> package to format these estimates into a human-readable form, presenting the ATE and its corresponding 95% CIs for each model. This presentation facilitates clear communication of the estimated treatment effects, allowing for direct comparison between the models and highlighting the effect of including baseline characteristics and their interactions on estimating the ATE <span class="co">[</span><span class="ot">@hester2022GLUE</span><span class="co">]</span>.</span>
<span id="cb36-686"><a href="#cb36-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-687"><a href="#cb36-687" aria-hidden="true" tabindex="-1"></a>This simulation-based approach to estimating the ATE underscores the importance of considering model complexity and the roles of confounders and mediators in causal inference analyses. By comparing the ATE estimates from different models, we can assess the sensitivity of our causal conclusions to various assumptions and modelling strategies.</span>
<span id="cb36-688"><a href="#cb36-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-691"><a href="#cb36-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-692"><a href="#cb36-692" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lst-atesimppendix</span></span>
<span id="cb36-693"><a href="#cb36-693" aria-hidden="true" tabindex="-1"></a><span class="co">#| lst-cap: "Code."</span></span>
<span id="cb36-694"><a href="#cb36-694" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb36-695"><a href="#cb36-695" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Code for calculating the average treatment effect."</span></span>
<span id="cb36-696"><a href="#cb36-696" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb36-697"><a href="#cb36-697" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb36-698"><a href="#cb36-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-699"><a href="#cb36-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-700"><a href="#cb36-700" aria-hidden="true" tabindex="-1"></a><span class="co"># use `clarify` package to obtain ATE</span></span>
<span id="cb36-701"><a href="#cb36-701" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(clarify)){<span class="fu">install.packages</span>(<span class="st">"clarify"</span>)} <span class="co"># clarify package</span></span>
<span id="cb36-702"><a href="#cb36-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-703"><a href="#cb36-703" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate fit 1 ATE</span></span>
<span id="cb36-704"><a href="#cb36-704" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb36-705"><a href="#cb36-705" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_no_control<span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_no_control)  </span>
<span id="cb36-706"><a href="#cb36-706" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_std <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_standard)</span>
<span id="cb36-707"><a href="#cb36-707" aria-hidden="true" tabindex="-1"></a>sim_coefs_fit_int <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_interaction)</span>
<span id="cb36-708"><a href="#cb36-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-709"><a href="#cb36-709" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, no controls</span></span>
<span id="cb36-710"><a href="#cb36-710" aria-hidden="true" tabindex="-1"></a>sim_est_fit_no_control <span class="ot">&lt;-</span></span>
<span id="cb36-711"><a href="#cb36-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb36-712"><a href="#cb36-712" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_no_control,</span>
<span id="cb36-713"><a href="#cb36-713" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A_1"</span>,</span>
<span id="cb36-714"><a href="#cb36-714" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A_1 <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb36-715"><a href="#cb36-715" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb36-716"><a href="#cb36-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb36-717"><a href="#cb36-717" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-718"><a href="#cb36-718" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 1 (L is a confounder)</span></span>
<span id="cb36-719"><a href="#cb36-719" aria-hidden="true" tabindex="-1"></a>sim_est_fit_std <span class="ot">&lt;-</span></span>
<span id="cb36-720"><a href="#cb36-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb36-721"><a href="#cb36-721" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_std,</span>
<span id="cb36-722"><a href="#cb36-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A_1"</span>,</span>
<span id="cb36-723"><a href="#cb36-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A_1 <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb36-724"><a href="#cb36-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb36-725"><a href="#cb36-725" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb36-726"><a href="#cb36-726" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-727"><a href="#cb36-727" aria-hidden="true" tabindex="-1"></a><span class="co"># marginal risk difference ATE, simulation-based: model 2 (L is a mediator)</span></span>
<span id="cb36-728"><a href="#cb36-728" aria-hidden="true" tabindex="-1"></a>sim_est_fit_int <span class="ot">&lt;-</span></span>
<span id="cb36-729"><a href="#cb36-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_ame</span>(</span>
<span id="cb36-730"><a href="#cb36-730" aria-hidden="true" tabindex="-1"></a>    sim_coefs_fit_int,</span>
<span id="cb36-731"><a href="#cb36-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="st">"A_1"</span>,</span>
<span id="cb36-732"><a href="#cb36-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">subset =</span> A_1 <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb36-733"><a href="#cb36-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> <span class="st">"RD"</span>,</span>
<span id="cb36-734"><a href="#cb36-734" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb36-735"><a href="#cb36-735" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-736"><a href="#cb36-736" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain summaries</span></span>
<span id="cb36-737"><a href="#cb36-737" aria-hidden="true" tabindex="-1"></a>summary_sim_coefs_fit_no_control <span class="ot">&lt;-</span></span>
<span id="cb36-738"><a href="#cb36-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(sim_est_fit_no_control, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb36-739"><a href="#cb36-739" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_std <span class="ot">&lt;-</span></span>
<span id="cb36-740"><a href="#cb36-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(sim_est_fit_std, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb36-741"><a href="#cb36-741" aria-hidden="true" tabindex="-1"></a>summary_sim_est_fit_int <span class="ot">&lt;-</span></span>
<span id="cb36-742"><a href="#cb36-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(sim_est_fit_int, <span class="at">null =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">RD</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>))</span>
<span id="cb36-743"><a href="#cb36-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-744"><a href="#cb36-744" aria-hidden="true" tabindex="-1"></a><span class="co"># get coefficients for reporting</span></span>
<span id="cb36-745"><a href="#cb36-745" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 1, with 95% CI</span></span>
<span id="cb36-746"><a href="#cb36-746" aria-hidden="true" tabindex="-1"></a>ATE_fit_no_control  <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb36-747"><a href="#cb36-747" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE = {round(summary_sim_coefs_fit_no_control[3, 1], 2)}, </span></span>
<span id="cb36-748"><a href="#cb36-748" aria-hidden="true" tabindex="-1"></a><span class="st">  CI = [{round(summary_sim_coefs_fit_no_control[3, 2], 2)},</span></span>
<span id="cb36-749"><a href="#cb36-749" aria-hidden="true" tabindex="-1"></a><span class="st">  {round(summary_sim_coefs_fit_no_control[3, 3], 2)}]"</span></span>
<span id="cb36-750"><a href="#cb36-750" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-751"><a href="#cb36-751" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 2, with 95% CI</span></span>
<span id="cb36-752"><a href="#cb36-752" aria-hidden="true" tabindex="-1"></a>ATE_fit_std <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb36-753"><a href="#cb36-753" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ATE = {round(summary_sim_est_fit_std[3, 1], 2)}, </span></span>
<span id="cb36-754"><a href="#cb36-754" aria-hidden="true" tabindex="-1"></a><span class="st">  CI = [{round(summary_sim_est_fit_std[3, 2], 2)},</span></span>
<span id="cb36-755"><a href="#cb36-755" aria-hidden="true" tabindex="-1"></a><span class="st">  {round(summary_sim_est_fit_std[3, 3], 2)}]"</span></span>
<span id="cb36-756"><a href="#cb36-756" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-757"><a href="#cb36-757" aria-hidden="true" tabindex="-1"></a><span class="co"># ate for fit 3, with 95% CI</span></span>
<span id="cb36-758"><a href="#cb36-758" aria-hidden="true" tabindex="-1"></a>ATE_fit_int <span class="ot">&lt;-</span></span>
<span id="cb36-759"><a href="#cb36-759" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb36-760"><a href="#cb36-760" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE = {round(summary_sim_est_fit_int[3, 1], 2)},</span></span>
<span id="cb36-761"><a href="#cb36-761" aria-hidden="true" tabindex="-1"></a><span class="st">    CI = [{round(summary_sim_est_fit_int[3, 2], 2)},</span></span>
<span id="cb36-762"><a href="#cb36-762" aria-hidden="true" tabindex="-1"></a><span class="st">    {round(summary_sim_est_fit_int[3, 3], 2)}]"</span></span>
<span id="cb36-763"><a href="#cb36-763" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-764"><a href="#cb36-764" aria-hidden="true" tabindex="-1"></a><span class="co"># coefs they used in the manuscript</span></span>
<span id="cb36-765"><a href="#cb36-765" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-766"><a href="#cb36-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-767"><a href="#cb36-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-768"><a href="#cb36-768" aria-hidden="true" tabindex="-1"></a>Using the <span class="in">`clarify`</span> package, we infer the ATE for the standard model is <span class="in">`r ATE_fit_std`</span>.</span>
<span id="cb36-769"><a href="#cb36-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-770"><a href="#cb36-770" aria-hidden="true" tabindex="-1"></a>Using the <span class="in">`clarify`</span> package, we infer the ATE for the model that conditions on the baseline exposure and baseline outcome to be:  <span class="in">`r ATE_fit_int`</span>, which is close to the values supplied to the data-generating mechanism. </span>
<span id="cb36-771"><a href="#cb36-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-772"><a href="#cb36-772" aria-hidden="true" tabindex="-1"></a>**Take-home message:** </span>
<span id="cb36-773"><a href="#cb36-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-774"><a href="#cb36-774" aria-hidden="true" tabindex="-1"></a>The baseline exposure and baseline outcome are often the most important variables to include for confounding control. The baseline exposure also allows us to estimate an incident-exposure effect. For this reason, we should endeavour to obtain at least three waves of data such that these variables and other baseline confounders are included at time 0, the exposure is included at time 1, and the outcome is included at time 2. </span>
<span id="cb36-775"><a href="#cb36-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-776"><a href="#cb36-776" aria-hidden="true" tabindex="-1"></a>{{&lt; pagebreak &gt;}}</span>
<span id="cb36-777"><a href="#cb36-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-778"><a href="#cb36-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-779"><a href="#cb36-779" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix E: Non-parametric Estimation of Average Treatment Effects Using Causal Forests {#appendix-causal-forests}</span></span>
<span id="cb36-780"><a href="#cb36-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-781"><a href="#cb36-781" aria-hidden="true" tabindex="-1"></a>This appendix provides a practical example of estimating average treatment effects (ATE) using a non-parametric approach, specifically applying causal forests. Unlike traditional regression models, causal forests allow for estimating treatment effects without imposing strict assumptions about the form of the relationship between treatment, covariates, and outcomes. This flexibility makes them particularly useful for analysing complex datasets where the treatment effect may vary across observations.</span>
<span id="cb36-782"><a href="#cb36-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-783"><a href="#cb36-783" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Causal Forest Model Implementation</span></span>
<span id="cb36-784"><a href="#cb36-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-785"><a href="#cb36-785" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Libraries**: the implementation begins with loading the necessary R libraries: <span class="in">`grf`</span> for estimating conditional and average treatment effects using causal forests and <span class="in">`glue`</span> for formatting the results for reporting.</span>
<span id="cb36-786"><a href="#cb36-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-787"><a href="#cb36-787" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>1. **Data generation**: the code assumes the presence of a data frame <span class="in">`data`</span> generated from the previous code snippet containing the variables:</span>
<span id="cb36-788"><a href="#cb36-788" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`A_1`</span>: Treatment indicator.</span>
<span id="cb36-789"><a href="#cb36-789" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`L_0`</span>: A covariate.</span>
<span id="cb36-790"><a href="#cb36-790" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`Y_2`</span>: Outcome of interest.</span>
<span id="cb36-791"><a href="#cb36-791" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`A_0`</span> and <span class="in">`Y_0`</span>: Baseline exposure and outcome, respectively. </span>
<span id="cb36-792"><a href="#cb36-792" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb36-793"><a href="#cb36-793" aria-hidden="true" tabindex="-1"></a>   Treatment (<span class="in">`W`</span>) and outcome (<span class="in">`Y`</span>) vectors are extracted from <span class="in">`data`</span> alongside a matrix <span class="in">`X`</span> that includes covariates and baseline characteristics.</span>
<span id="cb36-794"><a href="#cb36-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-795"><a href="#cb36-795" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Causal Forest model**: a causal forest model is fitted using the <span class="in">`causal_forest`</span> function from the <span class="in">`grf`</span> package <span class="co">[</span><span class="ot">@grf2024</span><span class="co">]</span>. This function takes the covariate matrix <span class="in">`X`</span>, the outcome vector <span class="in">`Y`</span>, and the treatment vector <span class="in">`W`</span> as inputs, and it returns a model object that can be used for further analysis.</span>
<span id="cb36-796"><a href="#cb36-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-797"><a href="#cb36-797" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Average Treatment Effect estimation**: the <span class="in">`average_treatment_effect`</span> function computes the ATE from the fitted causal forest model. This step is crucial as it quantifies the overall effect of the treatment across the population, adjusting for covariates included in the model.</span>
<span id="cb36-798"><a href="#cb36-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-799"><a href="#cb36-799" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Reporting**: The estimated ATE and its standard error (se) are extracted and formatted for reporting using the <span class="in">`glue`</span> package <span class="co">[</span><span class="ot">@hester2022GLUE</span><span class="co">]</span>. This facilitates clear communication of the results, showing the estimated effect size and its uncertainty.</span>
<span id="cb36-800"><a href="#cb36-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-801"><a href="#cb36-801" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Key Takeaways</span></span>
<span id="cb36-802"><a href="#cb36-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-803"><a href="#cb36-803" aria-hidden="true" tabindex="-1"></a>First, causal forests offer a robust way to estimate treatment effects without making parametric solid assumptions. This approach is particularly advantageous in settings where the treatment effect may vary with covariates or across different subpopulations. </span>
<span id="cb36-804"><a href="#cb36-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-805"><a href="#cb36-805" aria-hidden="true" tabindex="-1"></a>Second, the model estimates the ATE as the difference in expected outcomes between treated and untreated units, averaged across the population. This estimate reflects the overall effect of the treatment, accounting for the distribution of covariates in the sample. </span>
<span id="cb36-806"><a href="#cb36-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-807"><a href="#cb36-807" aria-hidden="true" tabindex="-1"></a>Third, we find that the estimated ATE by the causal forest model converges to the actual value used in the data-generating process (assumed to be 0.3). This demonstrates the effectiveness of causal forests in uncovering the true treatment effect from complex data.</span>
<span id="cb36-808"><a href="#cb36-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-809"><a href="#cb36-809" aria-hidden="true" tabindex="-1"></a>This example underscores the utility of semi-parametric and non-parametric methods, such as causal forests, in causal inference analyses.</span>
<span id="cb36-810"><a href="#cb36-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-813"><a href="#cb36-813" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb36-814"><a href="#cb36-814" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: causal_forest</span></span>
<span id="cb36-815"><a href="#cb36-815" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb36-816"><a href="#cb36-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-817"><a href="#cb36-817" aria-hidden="true" tabindex="-1"></a><span class="co"># load causal forest library </span></span>
<span id="cb36-818"><a href="#cb36-818" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grf) <span class="co"># estimate conditional and average treatment effects</span></span>
<span id="cb36-819"><a href="#cb36-819" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue) <span class="co"># reporting </span></span>
<span id="cb36-820"><a href="#cb36-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-821"><a href="#cb36-821" aria-hidden="true" tabindex="-1"></a><span class="co">#  'data' is our data frame with columns 'A_1' for treatment, 'L_0' for a covariate, and 'Y_2' for the outcome</span></span>
<span id="cb36-822"><a href="#cb36-822" aria-hidden="true" tabindex="-1"></a><span class="co">#  we also have the baseline exposure 'A_0' and 'Y_0'</span></span>
<span id="cb36-823"><a href="#cb36-823" aria-hidden="true" tabindex="-1"></a><span class="co">#  ensure W (treatment) and Y (outcome) are vectors</span></span>
<span id="cb36-824"><a href="#cb36-824" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data<span class="sc">$</span>A_1)  <span class="co"># Treatment</span></span>
<span id="cb36-825"><a href="#cb36-825" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data<span class="sc">$</span>Y_2)  <span class="co"># Outcome</span></span>
<span id="cb36-826"><a href="#cb36-826" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data[, <span class="fu">c</span>(<span class="st">"L_0"</span>, <span class="st">"A_0"</span>, <span class="st">"Y_0"</span>)])</span>
<span id="cb36-827"><a href="#cb36-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-828"><a href="#cb36-828" aria-hidden="true" tabindex="-1"></a><span class="co"># fit causal forest model </span></span>
<span id="cb36-829"><a href="#cb36-829" aria-hidden="true" tabindex="-1"></a>fit_causal_forest <span class="ot">&lt;-</span> <span class="fu">causal_forest</span>(X, Y, W)</span>
<span id="cb36-830"><a href="#cb36-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-831"><a href="#cb36-831" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the average treatment effect (ATE)</span></span>
<span id="cb36-832"><a href="#cb36-832" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> <span class="fu">average_treatment_effect</span>(fit_causal_forest)</span>
<span id="cb36-833"><a href="#cb36-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-834"><a href="#cb36-834" aria-hidden="true" tabindex="-1"></a><span class="co"># make data frame for reporting using "glue' </span></span>
<span id="cb36-835"><a href="#cb36-835" aria-hidden="true" tabindex="-1"></a>ate<span class="ot">&lt;-</span> <span class="fu">data.frame</span>(ate)</span>
<span id="cb36-836"><a href="#cb36-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-837"><a href="#cb36-837" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ate for report</span></span>
<span id="cb36-838"><a href="#cb36-838" aria-hidden="true" tabindex="-1"></a>ATE_fit_causal_forest <span class="ot">&lt;-</span></span>
<span id="cb36-839"><a href="#cb36-839" aria-hidden="true" tabindex="-1"></a>  glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb36-840"><a href="#cb36-840" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE = {round(ate[1, 1], 2)}, se = {round(ate[2, 1], 2)}"</span></span>
<span id="cb36-841"><a href="#cb36-841" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-842"><a href="#cb36-842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb36-843"><a href="#cb36-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-844"><a href="#cb36-844" aria-hidden="true" tabindex="-1"></a>Causal forest estimates the average treatment effect as <span class="in">`r ATE_fit_causal_forest`</span>. This approach converges to the true value supplied to the generating mechanism of 0.3</span>
<span id="cb36-845"><a href="#cb36-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-846"><a href="#cb36-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-847"><a href="#cb36-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-848"><a href="#cb36-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-849"><a href="#cb36-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-850"><a href="#cb36-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-851"><a href="#cb36-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-852"><a href="#cb36-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-853"><a href="#cb36-853" aria-hidden="true" tabindex="-1"></a><span class="fu">## </span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>